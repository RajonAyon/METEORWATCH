<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Asteroid Impact Analysis</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
  body { display: flex; background: #0a0a0a; }
  #sidebar { 
    width: 280px; 
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
    color: white; 
    padding: 20px; 
    box-sizing: border-box; 
    overflow-y: auto;
    border-right: 2px solid #ff6600;
  }
  #map { flex: 1; height: 100vh; position: relative; }
  .data-item { 
    margin-bottom: 12px; 
    padding: 8px;
    background: rgba(255, 102, 0, 0.1);
    border-radius: 5px;
    border-left: 3px solid #ff6600;
  }
  .data-item b { color: #ff6600; }
  .tab-button {
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
    color: white;
    border: 1px solid #333;
    padding: 12px;
    margin: 5px 0;
    width: 100%;
    text-align: left;
    cursor: pointer;
    border-radius: 8px;
    font-size: 13px;
    transition: all 0.3s ease;
  }
  .tab-button:hover {
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    border-color: #ff6600;
    transform: translateX(5px);
  }
  .tab-button.active {
    background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
    color: white;
    font-weight: bold;
    border-color: #ff6600;
    box-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
  }
  #impactContainer {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 400px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
    color: white;
    border-radius: 12px;
    font-family: sans-serif;
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
    z-index: 1000;
    border: 2px solid #ff6600;
  }
  .tab-header {
    padding: 18px;
    background: linear-gradient(135deg, #ff6600 0%, #cc5200 100%);
    font-weight: bold;
    border-radius: 10px 10px 0 0;
    font-size: 17px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  }
  .tab-content {
    padding: 20px;
    background: #1a1a1a;
    border-radius: 0 0 10px 10px;
  }
  .info-section {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 102, 0, 0.1);
    border-radius: 8px;
    border-left: 3px solid #ff6600;
  }
  .info-section b {
    color: #ff6600;
  }
  .chart-container {
    margin: 15px 0;
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
  }
  h2, h3 { color: #ff6600; text-shadow: 0 0 10px rgba(255, 102, 0, 0.3); }
  hr { border-color: #ff6600; margin: 20px 0; opacity: 0.3; }
</style>
</head>
<body>

    <div id="sidebar">
        <h2>🌍 Asteroid Impact</h2>
        <div class="data-item"><b>Radius:</b> <span id="radius"></span> m</div>
        <div class="data-item"><b>Density:</b> <span id="density"></span> kg/m³</div>
        <div class="data-item"><b>Velocity:</b> <span id="velocity"></span> km/s</div>
        <div class="data-item"><b>Angle:</b> <span id="angle"></span>°</div>
        
        <hr>
        <h3>📊 Analysis</h3>
        
        <button class="tab-button active" onclick="showTab('energy')">⚡ Impact Energy</button>
        <button class="tab-button" onclick="showTab('atmospheric')">🌫️ Atmospheric Entry</button>
        <button class="tab-button" onclick="showTab('crater')">🕳️ Crater Dimensions</button>
        <button class="tab-button" onclick="showTab('thermal')">🔥 Thermal Radiation</button>
        <button class="tab-button" onclick="showTab('seismic')">📈 Seismic Effects</button>
        <button class="tab-button" onclick="showTab('Windeffects')">💨 Wind Effects</button>
        <button class="tab-button" onclick="showTab('water')">🌊 Water Effects</button>
        <button class="tab-button" onclick="showTab('global')">🌐 Global Effects</button>
        
        <hr>
        
        <!-- Social Sharing Section -->
        <h3>🔗 Share</h3>
        <button id="shareTwitter" style="width:100%; padding:10px; margin-bottom:5px; background:#1DA1F2; color:white; border:none; border-radius:5px; cursor:pointer;">🐦 Twitter</button>
        <button id="shareFacebook" style="width:100%; padding:10px; margin-bottom:5px; background:#4267B2; color:white; border:none; border-radius:5px; cursor:pointer;">📘 Facebook</button>
        <button id="shareInstagram" style="width:100%; padding:10px; margin-bottom:5px; background:#C13584; color:white; border:none; border-radius:5px; cursor:pointer;">📸 Instagram</button>
      
        <hr>
        <button id="goBackBtn" style="width: 100%; padding: 12px; margin-top: 10px; background: orange; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s;">
          🔙 Go Back
        </button>
      </div>
      
      <script>
      // URL of the current simulation (you can customize this if you generate dynamic URLs)
      const currentURL = window.location.href;
      
      // Twitter
      document.getElementById('shareTwitter').onclick = () => {
          const text = encodeURIComponent("Check out my asteroid impact simulation!");
          const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(currentURL)}&text=${text}`;
          window.open(url, "_blank");
      };
      
      // Facebook
      document.getElementById('shareFacebook').onclick = () => {
          const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentURL)}`;
          window.open(url, "_blank");
      };
      
      // Instagram (cannot directly share URLs, so copy link for user)
      document.getElementById('shareInstagram').onclick = () => {
          navigator.clipboard.writeText(currentURL).then(() => {
              alert("Link copied! You can now paste it in Instagram bio or story.");
          }).catch(err => {
              alert("Failed to copy link. Try manually.");
          });
      };
      </script>
      
<script>
// URL of the current simulation (you can customize this if you generate dynamic URLs)
const currentURL = window.location.href;

// Twitter
document.getElementById('shareTwitter').onclick = () => {
    const text = encodeURIComponent("Check out my asteroid impact simulation!");
    const url = `https://twitter.com/intent/tweet?url=${encodeURIComponent(currentURL)}&text=${text}`;
    window.open(url, "_blank");
};

// Facebook
document.getElementById('shareFacebook').onclick = () => {
    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentURL)}`;
    window.open(url, "_blank");
};

// Instagram (cannot directly share URLs, so copy link for user)
document.getElementById('shareInstagram').onclick = () => {
    navigator.clipboard.writeText(currentURL).then(() => {
        alert("Link copied! You can now paste it in Instagram bio or story.");
    }).catch(err => {
        alert("Failed to copy link. Try manually.");
    });
};
</script>


<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let mainMap = null;
let currentMapLayer = null;

document.getElementById('goBackBtn').addEventListener('click', () => {
    window.history.back();
});


// ------------------------------
// 1️⃣ Format number with metric prefixes (k, M, G, T, P)
// ------------------------------
function formatMetric(num) {
    const absNum = Math.abs(num);

    // Large numbers
    if (absNum >= 1e18) return (num / 1e18).toFixed(2) + ' E'; // Exa
    if (absNum >= 1e15) return (num / 1e15).toFixed(2) + ' P'; // Peta
    if (absNum >= 1e12) return (num / 1e12).toFixed(2) + ' T'; // Tera
    if (absNum >= 1e9)  return (num / 1e9).toFixed(2) + ' G';  // Giga
    if (absNum >= 1e6)  return (num / 1e6).toFixed(2) + ' M';  // Mega
    if (absNum >= 1e3)  return (num / 1e3).toFixed(2) + ' k';  // kilo

    // Small numbers
    if (absNum >= 1e-3) return (num * 1e3).toFixed(2) + ' m';  // milli
    if (absNum >= 1e-6) return (num * 1e6).toFixed(2) + ' μ';  // micro
    if (absNum >= 1e-9) return (num * 1e9).toFixed(2) + ' n';  // nano
    if (absNum >= 1e-12) return (num * 1e12).toFixed(2) + ' p'; // pico
    if (absNum >= 1e-15) return (num * 1e15).toFixed(2) + ' f'; // femto
    if (absNum >= 1e-18) return (num * 1e18).toFixed(2) + ' a'; // atto

    return num.toFixed(2); // very small numbers smaller than 1e-18
}




// ------------------------------
// 2️⃣ Format number into words: millions, billions, trillions
// ------------------------------
function formatLargeNumberWords(num) {
    const absNum = Math.abs(num);

    if (absNum >= 1e33) return (num / 1e33).toFixed(2) + ' decillion';
    if (absNum >= 1e30) return (num / 1e30).toFixed(2) + ' nonillion';
    if (absNum >= 1e27) return (num / 1e27).toFixed(2) + ' octillion';
    if (absNum >= 1e24) return (num / 1e24).toFixed(2) + ' septillion';
    if (absNum >= 1e21) return (num / 1e21).toFixed(2) + ' sextillion';
    if (absNum >= 1e18) return (num / 1e18).toFixed(2) + ' quintillion';
    if (absNum >= 1e15) return (num / 1e15).toFixed(2) + ' quadrillion';
    if (absNum >= 1e12) return (num / 1e12).toFixed(2) + ' trillion';
    if (absNum >= 1e9)  return (num / 1e9).toFixed(2) + ' billion';
    if (absNum >= 1e6)  return (num / 1e6).toFixed(2) + ' million';

    return num.toFixed(2);
}



let asteroidData = null;


document.addEventListener("DOMContentLoaded", async () => {

    const response = await fetch("/get-custom-data", {
        method: "GET",
        credentials: "same-origin"
    });
    
    if (!response.ok) {
        console.error(`Error: ${response.status}`);
        alert("No calculation data found. Please go back and calculate first.");
        return;
    }
    
    const asteroidSession = await response.json();
    console.log("Retrieved from session:", asteroidSession);
    
    // Keep the full object globally
    window.asteroidSession = asteroidSession;
    
    // Extract inner info
    const asteroidInfo = asteroidSession.data || {};
    const isLand = asteroidSession.is_land ?? 0;
    const impactTarget = asteroidSession.impact_target || "Unknown";
    
    // Keep inner data separately too if needed
    asteroidData = asteroidInfo; // inner data
    window.asteroidData = asteroidInfo;
    
    // Update sidebar safely
    const updateText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.innerText = value ?? "N/A";
    };
    
    updateText("radius", asteroidInfo.radius);
    updateText("density", asteroidInfo.density);
    updateText("velocity", asteroidInfo.velocity);
    updateText("angle", asteroidInfo.angle);
    updateText("isLand", isLand ? "Yes" : "No");
    updateText("impactTarget", impactTarget);

    console.log(`The material strength is ${asteroidInfo.materialStrength}`);

    // Initialize map or other functions
    mainMap = L.map('map').setView([asteroidInfo.lat, asteroidInfo.lon], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mainMap);

    L.marker([asteroidInfo.lat, asteroidInfo.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff6600; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 20px #ff6600;"></div>',
            iconSize: [20, 20]
        })
    })
    .addTo(mainMap)
    .bindPopup(`<b>Impact Site</b><br>Lat: ${asteroidInfo.lat}<br>Lon: ${asteroidInfo.lon}`)
    .openPopup();

    showTab('energy');

});

    




function sendPopulationRequest(lat, lon, radius) {
    fetch("/estimate_population", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Population estimate:", data.population);
        showOnMap(lat, lon, radius, data.population);
    });
}

// Function to request population from backend
async function getPopulation(lat, lon, radius) {
    try {
        const response = await fetch("/estimate_population", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
        });

        const data = await response.json();
        console.log("Estimated population:", data.population);

        // You can now update your UI with the population
        document.getElementById("populationResult").innerText =
            `Population in area: ${data.population}`;
    } catch (err) {
        console.error("Error fetching population:", err);
    }
}






async function showTab(tabName, event) {
    // Handle tab button active state
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    if (event) event.currentTarget.classList.add('active'); // use currentTarget

    // Remove existing container
    const existingContainer = document.getElementById("impactContainer");
    if (existingContainer) {
        existingContainer.remove();
    }

    // Remove existing map layer
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }

    // Create new container
    const container = document.createElement("div");
    container.id = "impactContainer";
    document.getElementById('map').appendChild(container);

    // Determine header and content
    let headerText = "";
    let content = "";

    switch(tabName) {
        case 'energy':
            headerText = "⚡ Impact Energy & Recurrence";
            content = generateEnergyContent();
            break;
        case 'atmospheric':
            headerText = "🌫️ Atmospheric Entry";
            content = generateAtmosphericContent();
            break;
        case 'crater':
            headerText = "🕳️ Crater Dimensions & Melt";
            content = generateCraterContent();
            break;
        case 'thermal':
            headerText = "🔥 Thermal Radiation";
            content = await generateThermalContent();
            break;
        case 'seismic':
            headerText = "📈 Seismic Effects";
            content = await generateSeismicContent();
            break;
        case 'Windeffects':
            headerText = "💨 WindEffects";
            content = await generateWindContent();
            break;
        case 'water':
            headerText = "🌊 Effect of Water Layer";
            content = await generateWaterContent();
            break;
        case 'global':
            headerText = "🌐 Global Effects";
            content = await generateGlobalEffectsContent();
            break;
    }

    // Add tab header and content to container
    const tabHeader = document.createElement("div");
    tabHeader.className = "tab-header";
    tabHeader.innerText = headerText;
    container.appendChild(tabHeader);

    const tabContent = document.createElement("div");
    tabContent.className = "tab-content";
    tabContent.innerHTML = content;
    container.appendChild(tabContent);

    if (tabName === 'energy') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initEnergyCharts();
        }, 50);
    }


    if (tabName === 'atmospheric') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initAtmosphericCharts();
        }, 50);
    }

    if (tabName === 'crater') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initCraterCharts();
            showCraterMap()
        }, 50);
    }

    if (tabName === 'thermal') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initThermalCharts();
            showThermalMap()
        }, 50);
    }
    
    if (tabName === 'seismic') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initSeismicCharts();
            showSeismicMap()
        }, 100);
    }

    if (tabName === 'water') {
        // Delay to ensure canvas elements exist
        setTimeout(() => {
            initWaterCharts();
            showWaterMap()
        }, 100);
    }
    
    if(tabName === 'Windeffects'){
        setTimeout(() => {
            initWindCharts();
            showWindMap()
        }, 100);
    }

    if(tabName === 'global'){
        setTimeout(() => {
            initGlobalEffectsCharts();
        
        }, 100);
    }
    


    // Optionally adjust map view
    if (asteroidData && asteroidData.lat && asteroidData.lon) {
        mainMap.setView([asteroidData.lat, asteroidData.lon], 8);
    }


    
}




function generateEnergyContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const angleDeg = asteroidData.angle;
    
    // Core calculations
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_Mt = E_joules / 4.184e15;
    const E_kt = E_Mt * 1000;
    
    // Historical context calculations
    const hiroshimaEquivalent = E_kt / 15;
    const krakatoaEquivalent = E_Mt / 200;
    const earthquakeEquivalent = Math.log10(E_joules) * 0.67 - 5.87;
    
    // Calculate recurrence interval
    const recurrenceYears = 500000 * Math.pow(E_joules / (0.5 * (4/3) * Math.PI * Math.pow(1000, 3) * 2000 * Math.pow(20000, 2)), 0.9);

    return `
        <div class="info-section" style="background: linear-gradient(135deg, #6200ea 0%, #3700b3 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
            <h3>⚡ Energy Analysis</h3>
            <b>Total Energy:</b> ${formatLargeNumberWords(E_joules)} J (${formatLargeNumberWords(E_Mt)} Mt TNT)<br>
            <b>Mass:</b> ${formatLargeNumberWords(m)} kg<br>
            <b>Average Recurrence:</b> ${formatLargeNumberWords(recurrenceYears)} years<br>
            <b>Equivalent to:</b> ${formatLargeNumberWords(hiroshimaEquivalent)} Hiroshima bombs
        </div>

        <div class="info-section" style="background: #212121; padding: 15px; border-radius: 10px; margin-bottom: 15px; color: #ffffff;">
            <h4>🧮 Equations & Explanation</h4>
            <p><b>1️⃣ Mass of Asteroid:</b> <code>m = (4/3) π r³ ρ</code><br>
            Calculates total mass of asteroid.<br>
            <ul>
                <li><b>r:</b> radius (m)</li>
                <li><b>ρ:</b> density (kg/m³)</li>
            </ul></p>

            <p><b>2️⃣ Kinetic Energy:</b> <code>E = ½ m v²</code><br>
            Total energy of asteroid due to motion.<br>
            <ul>
                <li><b>m:</b> mass (kg)</li>
                <li><b>v:</b> velocity (m/s)</li>
            </ul></p>

            <p><b>3️⃣ Energy in Megatons:</b> <code>E(Mt) = E(J) / 4.184×10¹⁵</code><br>
            Converts Joules to TNT equivalent.<br>
            <ul>
                <li>1 Mt TNT = 4.184×10¹⁵ J</li>
            </ul></p>

            <p><b>4️⃣ Hiroshima Equivalent:</b> <code>E_Hiroshima = E_kt / 15</code><br>
            How many Hiroshima bombs equal this energy.<br>
            <ul>
                <li>1 Hiroshima bomb ≈ 15 kt</li>
            </ul></p>

            <p><b>5️⃣ Recurrence Interval:</b> <code>Recurrence ≈ 500,000 * (E / referenceEnergy)^0.9</code><br>
            Estimates how often an asteroid of this energy hits Earth.<br>
            <ul>
                <li><b>referenceEnergy:</b> small asteroid baseline (kg, m/s)</li>
            </ul></p>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="energyComparisonChart" height="250"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="historicalEventsChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="energyDistributionChart" height="220"></canvas>
        </div>
    `;
}


function initEnergyCharts() {
    if (!asteroidData) return;

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_Mt = (E_joules / 4.184e15).toFixed(2);

    // Energy Comparison Chart (logarithmic scale)
    const energyComparisons = [
        { label: 'Lightning Strike', energy: 1e9 },
        { label: 'Little Boy (Hiroshima)', energy: 6.3e13 },
        { label: 'Tsar Bomba', energy: 2.1e17 },
        { label: 'This Impact', energy: E_joules },
        { label: 'Krakatoa Eruption', energy: 8.4e17 },
        { label: 'Chicxulub Impact', energy: 4.2e23 }
    ].sort((a, b) => a.energy - b.energy);

    new Chart(document.getElementById('energyComparisonChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: energyComparisons.map(e => e.label),
            datasets: [{
                label: 'Energy (Joules)',
                data: energyComparisons.map(e => Math.log10(e.energy)),
                backgroundColor: energyComparisons.map(e => 
                    e.label === 'This Impact' ? '#ff4081' : '#6200ea'),
                borderColor: '#ffffff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Energy Release Comparison (Log Scale)',
                    color: '#ffffff'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: 'Log₁₀(Joules)',
                        color: '#ffffff'
                    }
                }
            }
        }
    });

    // Historical Events Timeline
    const historicalEvents = [
        { year: 1908, event: 'Tunguska', energy: 15 },
        { year: 1945, event: 'Hiroshima', energy: 0.015 },
        { year: 1961, event: 'Tsar Bomba', energy: 50 },
        { year: 2013, event: 'Chelyabinsk', energy: 0.4 },
        { year: 2023, event: 'This Impact', energy: E_Mt }
    ];

    new Chart(document.getElementById('historicalEventsChart').getContext('2d'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Historical Impact Events',
                data: historicalEvents.map(e => ({
                    x: e.year,
                    y: Math.log10(e.energy),
                    label: e.event
                })),
                backgroundColor: historicalEvents.map(e => 
                    e.event === 'This Impact' ? '#ff4081' : '#3700b3'),
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const point = historicalEvents[context.dataIndex];
                            return `${point.event}: ${point.energy} Mt TNT`;
                        }
                    }
                }
            }
        }
    });

    // Energy Distribution Chart
    const energyDistribution = {
        labels: ['Kinetic Energy', 'Thermal Radiation', 'Seismic Waves', 'Atmospheric Blast', 'Other Effects'],
        datasets: [{
            data: [45, 30, 15, 8, 2],
            backgroundColor: [
                '#6200ea',
                '#ff4081',
                '#00bcd4',
                '#64dd17',
                '#ffd600'
            ]
        }]
    };

    new Chart(document.getElementById('energyDistributionChart').getContext('2d'), {
        type: 'doughnut',
        data: energyDistribution,
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Impact Energy Distribution (%)',
                    color: '#ffffff'
                },
                legend: {
                    position: 'right',
                    labels: {
                        color: '#ffffff'
                    }
                }
            }
        }
    });
}









// Flexible function to fetch population for any lat, lon, radius
async function fetchPopulation(lat, lon, radius) {
    try {
        const response = await fetch("/estimate_population", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat: lat, lon: lon, radius: radius })
        });

        const data = await response.json();
        // Return the population number
        return data.population;
    } catch (err) {
        console.error("Error fetching population:", err);
        return 0; // fallback
    }
}



function generateAtmosphericContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    // --- Basic asteroid properties (units)
    const r = Number(asteroidData.radius);           // meters
    const rho = Number(asteroidData.density);        // kg/m^3 (projectile density)
    const v0 = Number(asteroidData.velocity) * 1000; // km/s -> m/s
    const angle = Number(asteroidData.angle) * Math.PI / 180; // radians from horizontal
    const L0 = 2 * r;                                 // characteristic length (m)
    const m = (4/3) * Math.PI * Math.pow(r, 3) * rho; // mass (kg)

    // --- Atmosphere & drag
    const CD = 2;      // drag coefficient (order-of-magnitude)
    const rho0 = 1.225; // kg/m^3 at sea level
    const H = 8000;    // m, scale height
    const atmosphereTop = 100000; // m (100 km)

    // --- Material strength (Pa)
    const Yi = Number(asteroidData.materialStrength);

    // -------------------------
    // Correct breakup altitude
    // Solve 0.5 * rho(z) * v^2 = Yi
    // rho(z) = rho0 * exp(-z/H)  =>  z = -H * ln( 2*Yi / (rho0 * v^2) )
    // If 2*Yi/(rho0*v^2) >= 1 => ln(...) >= 0 => z <= 0 or "no breakup" in atmosphere (survives)
    // -------------------------
    let zStar; // meters
    const ratio = (2 * Yi) / (rho0 * v0 * v0);

    if (!isFinite(ratio) || ratio <= 0) {
        // physically degenerate, treat as immediate breakup high (set zStar = 0)
        zStar = 0;
    } else if (ratio >= 1) {
        // dynamic pressure never reaches material strength in the atmosphere
        zStar = Infinity; // denote "no breakup due to dynamic pressure"
    } else {
        zStar = -H * Math.log(ratio); // m
        if (!isFinite(zStar) || isNaN(zStar)) zStar = 0;
    }

    const breakupAltitude = (zStar === Infinity) ? Infinity : Math.max(0, zStar / 1000); // km

    // -------------------------
    // Generate altitude array and compute velocity, pressure, energy vs altitude
    // altitudes: 100 km down to 0 km in steps of 5 km (same as your UI)
    // -------------------------
    const altitudes = Array.from({length: 21}, (_, i) => 100 - i * 5); // km
    const altitudes_m = altitudes.map(h => h * 1000); // m

    // Improved velocity decay model (same functional form you used but corrected for sin usage)
    // factor uses sin(angle) in denominator because path length through atmosphere increases with shallow angle
    // ensure we treat near-zero angle carefully
    const sinAngle = Math.max(1e-6, Math.sin(angle)); // avoid division by zero
    const factorCoeff = (3 * CD * rho0 * L0*100) / (4 * rho * H * sinAngle);

    const velocityDecay = altitudes_m.map(z => {
        // v(z) = v0 * exp(- factor * (1 - exp(-z/H)) )
        // keeps same analytic shape as before but will now work with corrected breakup
        return v0 * Math.exp(-factorCoeff * (1 - Math.exp(-z / H)));
    });

    const dynamicPressure = altitudes_m.map((z, idx) => {
        const localRho = rho0 * Math.exp(-z / H);
        const v = velocityDecay[idx];
        return 0.5 * localRho * v * v; // Pa
    });

    const energyDissipation = velocityDecay.map((v, idx) => {
        return 0.5 * m * (v0 * v0 - v * v); // Joules dissipated above that altitude
    });

    // -------------------------
    // Determine breakup index (altitude where breakup occurs)
    // - If zStar === Infinity => no breakup in atmosphere (survives)
    // - Else find the first altitude <= breakup altitude (zStar)
    // -------------------------
    let breakupIndex;
    if (zStar === Infinity) {
        breakupIndex = -1; // sentinel meaning "no breakup"
    } else {
        breakupIndex = altitudes_m.findIndex(z => z <= zStar);
        if (breakupIndex === -1) {
            // breakup altitude is below lowest listed altitude (below 0 km), treat as near-surface
            breakupIndex = altitudes.length - 1;
        }
    }
    

    // Survival fraction defined as remaining kinetic energy fraction after atmospheric dissipation until breakup
    let survivalFraction;
    if (zStar === Infinity) {
        survivalFraction = 1.0; // no breakup => survives intact (approx)
    } else {
        // energy dissipated until breakup altitude
        const E_diss = energyDissipation[breakupIndex];
        const E_initial = 0.5 * m * v0 * v0;
        survivalFraction = Math.max(0, 1 - (E_diss / E_initial));
    }

    // Maximum dynamic pressure encountered (use whole profile)
    const qMax = Math.max(...dynamicPressure);

    // -------------------------
    // Decide impact outcome
    // -------------------------
    let impactOutcome = "";
    if (zStar === Infinity) {
        // dynamic pressure never reaches material strength
        impactOutcome = "Impactor likely reaches ground intact";
    } else if (breakupAltitude > 30) {
        // High altitude breakup - fragments likely dispersed
        if (survivalFraction > 0.5) {
            impactOutcome = "High altitude airburst — larger fragments may reach ground";
        } else {
            impactOutcome = "High altitude airburst — most energy dissipated, small fragments only";
        }
    } else if (breakupAltitude > 10) {
        // Mid-altitude breakup
        if (survivalFraction > 0.7 || (r > 50 && rho > 3000)) {
            impactOutcome = "Mid-altitude breakup — significant fragments reach ground";
        } else {
            impactOutcome = "Airburst in atmosphere — fragments likely";
        }
    } else if (breakupAltitude > 1) {
        // Low altitude breakup
        if (survivalFraction > 0.6 || r > 30) {
            impactOutcome = "Low altitude breakup — substantial fragments impact surface";
        } else {
            impactOutcome = "Breakup near surface — fragments may hit ground";
        }
    } else {
        // Very low or surface breakup
        if (survivalFraction > 0.8 || (r > 20 && rho > 2500)) {
            impactOutcome = "Impactor reaches ground largely intact — crater formation likely";
        } else {
            impactOutcome = "Surface-level breakup — ground impact with fragmentation";
        }
    }

    // Velocity at the breakup or at ground index for reporting
    const reportIndex = (breakupIndex === -1) ? (altitudes.length - 1) : breakupIndex;
    const velocityAtReport = velocityDecay[reportIndex];
    const dynamicPressureAtReport = dynamicPressure[reportIndex];
    const energyDissAtReport = energyDissipation[reportIndex];

    // -------------------------
    // Expose arrays for charting/inspection by other functions
    // -------------------------
    window.atmosphericSimulation = {
        altitudes_km: altitudes,
        altitudes_m,
        velocityDecay,
        dynamicPressure,
        energyDissipation,
        breakupAltitude_km: (zStar === Infinity) ? Infinity : (zStar / 1000),
        breakupIndex,
        survivalFraction,
        impactOutcome,
        qMax
    };

    // -------------------------
    // Small helper formatters (local)
    // -------------------------
    function formatMetric(x) {
        if (!isFinite(x)) return "∞";
        const absx = Math.abs(x);
        if (absx === 0) return "0";
        const units = [
            {u: "P", v: 1e15},
            {u: "T", v: 1e12},
            {u: "G", v: 1e9},
            {u: "M", v: 1e6},
            {u: "k", v: 1e3},
            {u: "",  v: 1}
        ];
        for (const {u, v} of units) {
            if (absx >= v) return (x / v).toFixed( (v>=1e6) ? 2 : 1 ) + u;
        }
        return x.toExponential(2);
    }

    function formatLargeNumberWords(x) {
        if (!isFinite(x)) return String(x);
        if (x === 0) return "0";
        const absx = Math.abs(x);
        if (absx >= 1e12) return (x / 1e12).toFixed(2) + " trillion";
        if (absx >= 1e9)  return (x / 1e9).toFixed(2) + " billion";
        if (absx >= 1e6)  return (x / 1e6).toFixed(2) + " million";
        if (absx >= 1e3)  return (x / 1e3).toFixed(2) + " thousand";
        return x.toFixed(2);
    }

    // friendly numeric strings for the UI
    const formattedEnergy = formatLargeNumberWords(energyDissAtReport);
    const formattedDynamicPressure = (dynamicPressureAtReport >= 1e6) ? (dynamicPressureAtReport / 1e6).toFixed(3) + " MPa" : dynamicPressureAtReport.toExponential(3) + " Pa";
    const formattedVelocity = formatMetric(velocityAtReport) + " m/s";
    const formattedBreakupAlt = (breakupAltitude === Infinity) ? "No breakup in atmosphere" : breakupAltitude.toFixed(2) + " km";

    // -------------------------
    // Return the HTML snippet (same style as your original)
    // -------------------------
    return `
    <style>
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            z-index: 10000; /* stays above sidebar */
        }
        
        .info-tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;              /* ⬅️ make it narrower */
            background-color: rgba(0, 0, 0, 0.95);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;             /* ⬅️ more padding = taller box */
            position: absolute;
            z-index: 99999;
            bottom: 100%;
            left: 50%;
            transform: translateX(-70%);
            margin-bottom: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.8;          /* ⬅️ more line height = taller text spacing */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            white-space: normal;       /* ⬅️ allows wrapping */
            pointer-events: none;
        }
        
        .info-tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }
        .info-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            cursor: help;
            opacity: 0.9;
            font-size: 14px;
            user-select: none;
        }
        .breakup-tooltip {
            width: 150px !important;
            line-height: 1.8 !important;
            font-size: 12px !important;
        }
        
    </style>
    <div class="info-section" style="background: linear-gradient(135deg, #03a9f4 0%, #0288d1 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: white;">
        <h3>🌡️ Atmospheric Entry Analysis</h3>
        
        <b>Breakup Altitude:</b> ${formattedBreakupAlt}
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext breakup-tooltip">
                The altitude where the object fragments due to atmospheric forces. Higher = earlier breakup and more disintegration.
            </span>
        </div><br>
        
        <b>Velocity at Breakup/Ground:</b> ${formattedVelocity}
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Speed when it breaks apart or hits ground. Higher velocity = more kinetic energy and damage.</span>
        </div><br>
        
        <b>Dynamic Pressure at Reported Level:</b> ${formattedDynamicPressure}
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Aerodynamic stress from air resistance. High ram pressure causes atmospheric breakup.</span>
        </div><br>
        
        <b>Atmospheric Energy Dissipated (above):</b> ${formattedEnergy} J
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Kinetic energy lost to atmospheric drag and heating. More dissipation = less ground impact.</span>
        </div><br>
        
        <b>Fraction Reaching Surface (approx):</b> ${(survivalFraction * 100).toFixed(1)}%
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Estimated mass percentage surviving atmospheric entry. Lower = more complete burnup.</span>
        </div><br>
        
        <b>Impact Outcome:</b> ${impactOutcome}
        <div class="info-tooltip">
            <span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Ground impact severity assessment based on surviving mass, velocity, and energy.</span>
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="velocityDecayChart" height="250"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="dynamicPressureChart" height="250"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="energyDissipationChart" height="250"></canvas>
    </div>
    `;
}

function initAtmosphericCharts() {
    if (!asteroidData) return;

    const v0 = asteroidData.velocity * 1000; // m/s
    const angle = asteroidData.angle * Math.PI/180; // rad
    const L0 = asteroidData.radius*2;
    const rho = asteroidData.density;
    const m = (4/3) * Math.PI * Math.pow(asteroidData.radius,3) * rho;
    const CD = 2;
    const rho0 = 1.225;
    const H = 8000;

    const altitudes = Array.from({length: 21}, (_, i) => 100 - i*5); // km
    const velocityDecay = altitudes.map(h => {
        const z = h*1000;
        const factor = (3 * CD * rho0 * L0)/(4 * rho * H * Math.sin(angle));
        return v0 * Math.exp(-factor*(1-Math.exp(-z/H)));
    });
    const dynamicPressure = altitudes.map((h, idx) => 0.5 * rho0 * Math.exp(-h*1000/H) * Math.pow(velocityDecay[idx],2));
    const energyDissipation = altitudes.map((h, idx) => 0.5 * m * (v0*v0 - velocityDecay[idx]*velocityDecay[idx]));

    // Charts
    const chartOptions = (title, yLabel) => ({
        responsive:true,
        plugins:{
            title:{display:true,text:title,color:'#ffffff'},
            legend:{display:false}
        },
        scales:{
            y:{title:{display:true,text:yLabel,color:'#ffffff'}},
            x:{title:{display:true,text:'Altitude (km)',color:'#ffffff'}}
        }
    });

    new Chart(document.getElementById('velocityDecayChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Velocity (m/s)', data: velocityDecay, borderColor:'#03a9f4', backgroundColor:'rgba(3,169,244,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Velocity Decay vs Altitude','Velocity (m/s)')
    });

    new Chart(document.getElementById('dynamicPressureChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Dynamic Pressure (Pa)', data: dynamicPressure, borderColor:'#ff5722', backgroundColor:'rgba(255,87,34,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Dynamic Pressure vs Altitude','Pressure (Pa)')
    });

    new Chart(document.getElementById('energyDissipationChart').getContext('2d'), {
        type:'line',
        data:{
            labels: altitudes.map(h=>h+' km'),
            datasets:[{label:'Atmospheric Energy Dissipated (J)', data: energyDissipation, borderColor:'#00e676', backgroundColor:'rgba(0,230,118,0.2)', fill:true, tension:0.4}]
        },
        options: chartOptions('Atmospheric Energy Dissipation','Energy (J)')
    });
}



function willAsteroidReachGround(data) {
    const r = Number(data.radius);           // meters
    const rho = Number(data.density);        // kg/m³
    const v0 = Number(data.velocity) * 1000; // km/s -> m/s
    const Yi = Number(data.materialStrength) || 1e7; // Pa
    
    const rho0 = 1.225;
    const H = 8000;
    
    const ratio = (2 * Yi) / (rho0 * v0 * v0);
    if (!isFinite(ratio) || ratio <= 0) return false;
    if (ratio >= 1) return true;
    
    const zStar = -H * Math.log(ratio);
    const breakupAltitude_km = zStar / 1000;
    
    // Compute mass
    const volume = (4/3) * Math.PI * r**3;
    const mass = volume * rho;
    
    if (mass > 1e9) return true; // large asteroid survives
    
    // Small-medium asteroids: check breakup altitude
    return breakupAltitude_km < 10;
}






function showCraterMap() {
    if (!asteroidData) return;

    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }

    currentMapLayer = L.layerGroup();

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const isLand = asteroidData.is_land ?? 0;
    
    // Calculate crater dimensions
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    const D_simple_threshold = isLand ? 3000 : 4000;
    let D_final, depth, rim_height, crater_type;
    
    if (D_tr < D_simple_threshold) {
        crater_type = "Simple";
        D_final = D_tr;
        depth = D_final * 0.2;
        rim_height = depth * 0.04;
    } else {
        crater_type = "Complex";
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1;
        rim_height = depth * 0.05;
    }
    
    const ejecta_extent = D_final * 1.5;

    // Define zones
    const zones = [
        {
            radius: D_final / 2,
            color: '#8B0000',
            label: `Crater Bowl (${crater_type})`,
            fillOpacity: 0.7,
            details: `Diameter: ${(D_final/1000).toFixed(2)} km<br>Depth: ${(depth/1000).toFixed(3)} km`
        },
        {
            radius: D_final / 2 + rim_height,
            color: '#A0522D',
            label: 'Crater Rim',
            fillOpacity: 0.5,
            details: `Height: ${rim_height.toFixed(1)} m above ground`
        },
        {
            radius: ejecta_extent / 2,
            color: '#D2691E',
            label: 'Primary Ejecta Blanket',
            fillOpacity: 0.3,
            details: `Radius: ${(ejecta_extent/1000/2).toFixed(2)} km<br>Boulder field zone`
        },
        {
            radius: D_final * 2,
            color: '#CD853F',
            label: 'Secondary Ejecta Zone',
            fillOpacity: 0.2,
            details: `Scattered debris and fractured ground`
        },
        {
            radius: D_final * 3,
            color: '#DEB887',
            label: 'Seismic Damage Zone',
            fillOpacity: 0.1,
            details: `Ground shaking and structural damage`
        }
    ];

    // Sort by radius and draw
    zones.sort((a, b) => b.radius - a.radius);

    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });

    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(255,0,0,0.8);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Impact Point</b><br>
        Surface: ${isLand ? '🏔️ Land' : '🌊 Water'}<br>
        Crater: ${(D_final/1000).toFixed(2)} km diameter
    `);

    currentMapLayer.addTo(mainMap);

    // Fit bounds
    const maxRadius = Math.max(...zones.map(z => z.radius));
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

function generateCraterContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    // Check if asteroid will reach the ground
if (!willAsteroidReachGround(asteroidData)) {
    // Remove previous message if exists
    const oldMessage = document.getElementById("craterMessage");
    if (oldMessage) oldMessage.remove();

    // Create a centered modal
    const messageDiv = document.createElement("div");
    messageDiv.id = "craterMessage";
    messageDiv.style.position = "fixed";
    messageDiv.style.top = "50%";
    messageDiv.style.left = "50%";
    messageDiv.style.transform = "translate(-50%, -50%)";
    messageDiv.style.backgroundColor = "#ff5252";
    messageDiv.style.color = "white";
    messageDiv.style.padding = "30px 40px";
    messageDiv.style.borderRadius = "12px";
    messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
    messageDiv.style.textAlign = "center";
    messageDiv.style.zIndex = "9999";
    messageDiv.innerHTML = `
        <h2>💨 Asteroid Breakup</h2>
        <p>The asteroid will disintegrate in the atmosphere.<br><b>No crater will form on the surface.</b></p>
        <button id="closeCraterMessage" style="
            margin-top: 15px;
            padding: 8px 15px;
            background: white;
            color: #ff5252;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        ">Close</button>
    `;
    document.body.appendChild(messageDiv);

    // Close button functionality
    document.getElementById("closeCraterMessage").addEventListener("click", () => {
        messageDiv.remove();
    });

    return; // stop execution
}

    

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Crater dimensions using impact scaling laws
    const isLand = window.asteroidSession?.is_land ?? 0;
    const impactAngle = 45; // assume 45° typical impact
    
    // Transient crater diameter (Collins et al., 2005)
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    
    // Final crater diameter (simple vs complex crater)
    const D_simple_threshold = isLand ? 3000 : 4000; // meters
    let D_final, depth, rim_height, crater_type;
    
    if (D_tr < D_simple_threshold) {
        // Simple crater
        crater_type = "Simple Bowl-Shaped";
        D_final = D_tr;
        depth = D_final * 0.2; // depth is ~20% of diameter
        rim_height = depth * 0.04; // rim ~4% of depth
    } else {
        // Complex crater with central peak
        crater_type = "Complex with Central Peak";
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1; // shallower, ~10% of diameter
        rim_height = depth * 0.05;
    }
    
    // Crater volume
    const crater_volume = (Math.PI / 3) * Math.pow(D_final / 2, 2) * depth;
    
    // Ejecta blanket
    const ejecta_thickness_at_rim = rim_height * 2;
    const ejecta_extent = D_final * 1.5; // extends 1.5x crater diameter
    
    // Famous craters for comparison
    const famousCraters = [
        {name: 'Barringer (Meteor Crater)', diameter: 1200, location: 'Arizona, USA'},
        {name: 'Chicxulub', diameter: 180000, location: 'Mexico (Dinosaur extinction)'},
        {name: 'Vredefort', diameter: 300000, location: 'South Africa (Largest on Earth)'},
        {name: 'Sudbury', diameter: 130000, location: 'Canada'},
        {name: 'Manicouagan', diameter: 100000, location: 'Canada'},
        {name: 'This Impact', diameter: D_final, location: 'Current Simulation'}
    ].sort((a, b) => a.diameter - b.diameter);

    return `
<style>
    .info-tooltip {
        position: relative;
        display: inline-block;
        margin-left: 5px;
        z-index: 10000;
    }
    .info-tooltip .tooltiptext {
        visibility: hidden;
        width: 180px;
        background-color: rgba(0, 0, 0, 0.9);
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 6px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.5;
        pointer-events: none;
    }
    .info-tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: rgba(0,0,0,0.9) transparent transparent transparent;
    }
    .info-tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
    }
    .info-icon {
        cursor: help;
        font-size: 14px;
        opacity: 0.9;
        user-select: none;
    }
    .tooltip-diameter {
        width: 150px !important;      /* narrower */
        height: 80px !important;     /* taller */
        line-height: 1.6 !important;  /* more spacing */
        padding: 10px !important;     /* bigger padding */
        white-space: normal !important; /* allow text wrapping */
        transform: translateX(30%) !important; /* shift slightly to the right */
    }
    
</style>


<div class="info-section" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
    <h3 style="margin: 0 0 10px 0; color: white;">🕳️ Crater Characteristics</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <b>Crater Type:</b> ${crater_type}
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Classification: simple bowl-shaped crater or complex crater with central peak.</span>
            </span><br>
            <b>Final Diameter:</b> ${formatLargeNumberWords(D_final)} m
<span class="info-tooltip">
    <span class="info-icon">ℹ️</span>
    <span class="tooltiptext tooltip-diameter">Total rim-to-rim width of the crater, depends on impact energy.</span>
</span><br>

            <b>Depth:</b> ${formatLargeNumberWords(depth)} m
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Vertical distance from rim to the deepest point of the crater.</span>
            </span><br>
            <b>Rim Height:</b> ${formatLargeNumberWords(rim_height)} m
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Height of the crater rim above surrounding terrain.</span>
            </span>
        </div>
        <div>
            <b>Volume:</b> ${formatMetric(crater_volume)} m³
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Total volume of material excavated by the impact.</span>
            </span><br>
            <b>Impact Surface:</b> ${isLand ? '🏔️ Land' : '🌊 Water'}
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Indicates if the impact occurred on land or underwater.</span>
            </span><br>
            <b>Ejecta Extent:</b> ${formatLargeNumberWords(ejecta_extent)} m
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Maximum distance the ejected material reaches from the crater.</span>
            </span><br>
            <b>Depth/Diameter:</b> ${(depth/D_final * 100).toFixed(1)}%
            <span class="info-tooltip"><span class="info-icon">ℹ️</span>
                <span class="tooltiptext">Ratio of depth to diameter: indicates how deep or shallow the crater is.</span>
            </span>
        </div>
    </div>
</div>

<div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
    <h3 style="margin: 0 0 10px 0; color: #A0522D;">📐 Crater Profile</h3>
    <div style="position: relative; height: 200px; background: linear-gradient(to bottom, #87CEEB 0%, #D2691E 50%, #8B4513 100%); border-radius: 8px; overflow: hidden;">
        <svg width="100%" height="100%" viewBox="0 0 400 200" style="position: absolute; top: 0; left: 0;">
            <!-- Ground level -->
            <line x1="0" y1="100" x2="400" y2="100" stroke="#654321" stroke-width="2" stroke-dasharray="5,5"/>
            <!-- Crater bowl -->
            <path d="M 100 100 Q 200 ${100 + (depth/D_final)*80} 300 100" fill="#654321" stroke="#8B4513" stroke-width="2"/>
            <!-- Rim -->
            <path d="M 90 100 L 100 ${100 - (rim_height/depth)*20} L 110 100" fill="#A0522D" stroke="#654321" stroke-width="1.5"/>
            <path d="M 290 100 L 300 ${100 - (rim_height/depth)*20} L 310 100" fill="#A0522D" stroke="#654321" stroke-width="1.5"/>
            ${D_tr >= D_simple_threshold ? `
                <!-- Central peak for complex craters -->
                <path d="M 190 ${100 + (depth/D_final)*60} L 200 ${100 + (depth/D_final)*30} L 210 ${100 + (depth/D_final)*60}" fill="#8B7355" stroke="#654321" stroke-width="1.5"/>
            ` : ''}
            <!-- Labels -->
            <text x="200" y="95" text-anchor="middle" fill="white" font-size="12">Ground Level</text>
            <text x="200" y="${100 + (depth/D_final)*80 - 5}" text-anchor="middle" fill="white" font-size="11">Depth: ${(depth/1000).toFixed(2)} km</text>
            <text x="50" y="95" text-anchor="middle" fill="white" font-size="10">Rim</text>
        </svg>
    </div>
    <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
        ${crater_type} - Cross-sectional view (not to scale)
        <span class="info-tooltip"><span class="info-icon">ℹ️</span>
            <span class="tooltiptext">Diagram shows crater shape, rim, and depth (not to scale).</span>
        </span>
    </p>
</div>


        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="craterDimensionsChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="craterComparisonChart" height="250"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="ejectaDistributionChart" height="200"></canvas>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #A0522D;">🪨 Ejecta Characteristics</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b style="color: #D2691E;">Ejecta Volume:</b> ~${formatMetric(crater_volume * 2)} m³ 
                <span class="info-tooltip" style="margin-left: 5px;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 160px; line-height: 1.6; font-size: 12px;">
                        Total displaced material volume ejected from the crater.
                    </span>
                </span><br>
        
                <b style="color: #D2691E;">Blanket Thickness at Rim:</b> ${formatLargeNumberWords(ejecta_thickness_at_rim)} m
                <span class="info-tooltip" style="margin-left: 5px;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 160px; line-height: 1.6; font-size: 12px;">
                        Average thickness of ejecta layer near the crater rim.
                    </span>
                </span><br>
        
                <b style="color: #D2691E;">Maximum Ejecta Range:</b> ${formatLargeNumberWords(ejecta_extent)} m
                <span class="info-tooltip" style="margin-left: 5px;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 160px; line-height: 1.6; font-size: 12px;">
                        Furthest distance ejecta reaches from the crater center.
                    </span>
                </span><br>
        
                <b style="color: #D2691E;">Boulder Size:</b> Up to ${formatLargeNumberWords(D_final * 0.01)} m at rim
                <span class="info-tooltip" style="margin-left: 5px;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 160px; line-height: 1.6; font-size: 12px;">
                        Approximate maximum boulder size at crater rim.
                    </span>
                </span><br>
        
                <b style="color: #D2691E;">Fallback Time:</b> ~${Math.sqrt(2 * depth / 9.81).toFixed(1)} seconds
                <span class="info-tooltip" style="margin-left: 5px;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 160px; line-height: 1.6; font-size: 12px;">
                        Time it takes for ejected material to fall back to the crater floor.
                    </span>
                </span>
            </div>
        </div>
        

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d1810 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #A0522D;">
            <h3 style="margin: 0 0 10px 0; color: #D2691E;">💡 Crater Formation Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>Crater formation takes only ${Math.max(1, (D_final/1000/20).toFixed(0))} - ${Math.max(5, (D_final/1000/10).toFixed(0))} minutes</li>
                <li>The crater forms through three stages: contact/compression, excavation, and modification</li>
                <li>${crater_type === "Complex with Central Peak" ? 
                    "The central peak forms from elastic rebound of compressed rock" : 
                    "Simple craters maintain their bowl shape without central uplift"}</li>
                <li>Impact energy melts ~${(E_megatons * 0.01).toExponential(1)} cubic meters of rock</li>
                <li>The crater will erode ${isLand ? 'over millions of years' : 'rapidly if underwater'}</li>
                <li>Seismic shaking equivalent to magnitude ${Math.min(10, 0.67 * Math.log10(E_joules) - 5.87).toFixed(1)} earthquake</li>
                <li>${isLand ? 
                    'Material ejected can reach escape velocity and become meteorites' : 
                    'Water impact creates massive tsunamis radiating outward'}</li>
            </ul>
        </div>

        <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">🔬 Surface Effects</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Vaporized Rock:</b><br>
                    ${formatMetric(crater_volume * 0.1)} m³<br>
                    <span style="font-size: 0.85em; color: #aaa;">Superheated plasma cloud</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Melted Rock:</b><br>
                    ${formatMetric(crater_volume * 0.2)} m³<br>
                    <span style="font-size: 0.85em; color: #aaa;">Glass and impact melt</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Shocked Material:</b><br>
                    ${formatMetric(crater_volume * 0.5)} m³<br>
                    <span style="font-size: 0.85em; color: #aaa;">High-pressure metamorphism</span>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px;">
                    <b style="color: #00d4ff;">Fractured Rock:</b><br>
                    ${formatMetric(crater_volume * 2)} m³<br>
                    <span style="font-size: 0.85em; color: #aaa;">Shatter cones and breccia</span>
                </div>
            </div>
        </div>

        ${isLand ? `
        <div class="info-section" style="background: linear-gradient(135deg, #2d5016 0%, #3d6b1f 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">🌍 Land Impact Specifics</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                <li>Crater will be visible from space as a circular scar</li>
                <li>Creates a debris field extending ${(ejecta_extent/1000 * 3).toFixed(0)} km downrange</li>
                <li>Groundwater aquifers disrupted in ${(D_final/1000 * 2).toFixed(0)} km radius</li>
                <li>Local topography permanently altered</li>
                <li>Potential for mineral deposits (shocked quartz, diamonds)</li>
            </ul>
        </div>
        ` : `
        <div class="info-section" style="background: linear-gradient(135deg, #003d5c 0%, #005580 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">🌊 Water Impact Specifics</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                <li>Creates a transient water cavity ${(D_final/1000).toFixed(2)} km wide</li>
                <li>Generates tsunamis with heights up to ${Math.min(300, Math.sqrt(E_megatons) * 10).toFixed(0)} meters</li>
                <li>Steam explosion throws water ${(depth * 5 / 1000).toFixed(1)} km into atmosphere</li>
                <li>Crater may not be visible on seafloor due to water column</li>
                <li>Creates underwater shockwaves devastating to marine life</li>
            </ul>
        </div>
        `}
    `;
}

function initCraterCharts() {
    if (!asteroidData) return;

    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const isLand = window.asteroidSession?.is_land ?? 0;
    
    // Calculate crater dimensions
    const D_tr = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho, 0.333) * Math.pow(9.81, -0.22);
    const D_simple_threshold = isLand ? 3000 : 4000;
    let D_final, depth, rim_height;
    
    if (D_tr < D_simple_threshold) {
        D_final = D_tr;
        depth = D_final * 0.2;
        rim_height = depth * 0.04;
    } else {
        D_final = 1.17 * Math.pow(D_tr, 1.13);
        depth = D_final * 0.1;
        rim_height = depth * 0.05;
    }
    
    const crater_volume = (Math.PI / 3) * Math.pow(D_final / 2, 2) * depth;
    const ejecta_extent = D_final * 1.5;

    // Chart 1: Crater Dimensions Comparison
    new Chart(document.getElementById('craterDimensionsChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Diameter', 'Depth', 'Rim Height', 'Ejecta Extent'],
            datasets: [{
                label: 'Dimensions (meters)',
                data: [D_final, depth, rim_height, ejecta_extent],
                backgroundColor: ['#8B4513', '#A0522D', '#D2691E', '#CD853F'],
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                title: { display: true, text: 'Crater Dimensions', color: 'white', font: { size: 14 } }
            },
            scales: {
                y: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Meters (log scale)', color: 'white' }
                },
                x: { ticks: { color: 'white' }, grid: { color: '#333' } }
            }
        }
    });

    // Chart 2: Famous Craters Comparison
    const famousCraters = [
        {name: 'Barringer', diameter: 1200},
        {name: 'Chicxulub', diameter: 180000},
        {name: 'Vredefort', diameter: 300000},
        {name: 'Sudbury', diameter: 130000},
        {name: 'This Impact', diameter: D_final}
    ].sort((a, b) => a.diameter - b.diameter);

    new Chart(document.getElementById('craterComparisonChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: famousCraters.map(c => c.name),
            datasets: [{
                label: 'Crater Diameter (km)',
                data: famousCraters.map(c => c.diameter / 1000),
                backgroundColor: famousCraters.map(c => 
                    c.name === 'This Impact' ? '#ff6600' : '#A0522D'
                ),
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Comparison with Famous Impact Craters', color: 'white', font: { size: 14 } }
            },
            scales: {
                x: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Diameter (km, log scale)', color: 'white' }
                },
                y: { ticks: { color: 'white' }, grid: { color: '#333' } }
            }
        }
    });

    // Chart 3: Ejecta Distribution
    const ejecta_distances = [0, 0.5, 1, 1.5, 2, 2.5, 3, 4, 5].map(x => x * D_final);
    const ejecta_thickness = ejecta_distances.map(d => {
        if (d <= D_final/2) return rim_height * 2;
        return (rim_height * 2) * Math.pow((D_final/2) / d, 3);
    });

    new Chart(document.getElementById('ejectaDistributionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: ejecta_distances.map(d => (d/1000).toFixed(1) + ' km'),
            datasets: [{
                label: 'Ejecta Thickness (m)',
                data: ejecta_thickness,
                borderColor: '#CD853F',
                backgroundColor: 'rgba(205, 133, 63, 0.3)',
                fill: true,
                tension: 0.4,
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: 'white' } },
                title: { display: true, text: 'Ejecta Blanket Distribution', color: 'white', font: { size: 14 } }
            },
            scales: {
                y: { 
                    type: 'logarithmic',
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Thickness (meters, log scale)', color: 'white' }
                },
                x: { 
                    ticks: { color: 'white' }, 
                    grid: { color: '#333' },
                    title: { display: true, text: 'Distance from Crater Center', color: 'white' }
                }
            }
        }
    });
}



function showThermalMap() {
    if (!asteroidData) return;
    
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Calculate fireball radius and thermal radiation
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4); // meters
    const fireball_duration = 0.44 * Math.pow(E_megatons, 0.22); // seconds
    
    // Thermal radiation flux at different distances (J/cm²)
    // Based on nuclear weapon scaling laws adapted for asteroid impacts
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6; // Inside fireball
        
        // Thermal flux decreases with distance squared, accounting for atmospheric absorption
        const thermal_yield_fraction = 0.35; // 35% of energy as thermal radiation
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000; // J/cm²
        
        // Atmospheric absorption factor
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    // Calculate burn radii based on thermal flux thresholds
    // Third-degree burns: ~10 J/cm²
    // Second-degree burns: ~5 J/cm²
    // First-degree burns: ~2.5 J/cm²
    
    function getDistanceForFlux(target_flux) {
        let dist = fireball_radius;
        let flux = getThermalFlux(dist);
        
        // Binary search for distance
        let low = fireball_radius;
        let high = 1000000; // 1000 km max
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    
    // Define thermal zones
    const zones = [
        {
            radius: fireball_radius,
            color: '#FFFFFF',
            label: '🔥 Fireball Zone',
            fillOpacity: 0.9,
            details: `Radius: ${(fireball_radius/1000).toFixed(2)} km<br>Temperature: >10,000°C<br>Complete vaporization`
        },
        {
            radius: third_degree_radius,
            color: '#8B0000',
            label: '🔥 Third-Degree Burns',
            fillOpacity: 0.7,
            details: `Radius: ${(third_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >10 J/cm²<br>Full-thickness skin destruction<br>Clothing ignites`
        },
        {
            radius: second_degree_radius,
            color: '#FF4500',
            label: '🔥 Second-Degree Burns',
            fillOpacity: 0.5,
            details: `Radius: ${(second_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >5 J/cm²<br>Blistering and severe pain<br>Permanent scarring likely`
        },
        {
            radius: first_degree_radius,
            color: '#FFA500',
            label: '🔥 First-Degree Burns',
            fillOpacity: 0.3,
            details: `Radius: ${(first_degree_radius/1000).toFixed(2)} km<br>Thermal flux: >2.5 J/cm²<br>Sunburn-like symptoms<br>Skin redness and pain`
        },
        {
            radius: flash_blindness_radius,
            color: '#FFD700',
            label: '👁️ Flash Blindness Zone',
            fillOpacity: 0.15,
            details: `Radius: ${(flash_blindness_radius/1000).toFixed(2)} km<br>Temporary vision loss<br>Retinal damage possible<br>Duration: ${fireball_duration.toFixed(1)} seconds`
        }
    ];
    
    // Sort by radius (largest first) and draw
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ffffff; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #ff0000; box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 40px rgba(255,100,0,0.8);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Impact Point</b><br>
        Fireball: ${(fireball_radius/1000).toFixed(2)} km radius<br>
        Duration: ${fireball_duration.toFixed(1)} seconds<br>
        Peak Temperature: ${(Math.pow(E_megatons, 0.25) * 8000).toFixed(0)}°C
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show all thermal zones
    const maxRadius = Math.max(...zones.map(z => z.radius));
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateThermalContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    // Check if asteroid will reach the ground
    if (!willAsteroidReachGround(asteroidData)) {
        const oldMessage = document.getElementById("thermalMessage");
        if (oldMessage) oldMessage.remove();
        
        const messageDiv = document.createElement("div");
        messageDiv.id = "thermalMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#ff9800";
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>💨 Atmospheric Airburst</h2>
            <p>The asteroid will explode in the atmosphere.<br><b>Thermal effects still occur but are reduced.</b></p>
            <button id="closeThermalMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #ff9800;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        
        document.body.appendChild(messageDiv);
        
        document.getElementById("closeThermalMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
        
        return;
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Fireball calculations
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4); // meters
    const fireball_duration = 0.44 * Math.pow(E_megatons, 0.22); // seconds
    const fireball_temperature = Math.pow(E_megatons, 0.25) * 8000; // °C
    
    // Thermal radiation calculations
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6;
        
        const thermal_yield_fraction = 0.35;
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000;
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    function getDistanceForFlux(target_flux) {
        let low = fireball_radius;
        let high = 1000000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    const ignition_radius = getDistanceForFlux(20);



    
    
    const casualties_3rd = await fetchPopulation(asteroidData.lat, asteroidData.lon, third_degree_radius/1000);
    const casualties_2nd = await fetchPopulation(asteroidData.lat, asteroidData.lon, second_degree_radius/1000);
    const casualties_1st = await fetchPopulation(asteroidData.lat, asteroidData.lon, first_degree_radius/1000);
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: black; padding: 10px; color: white;">
        <div>
            <span><b>Fireball Radius:</b></span> ${formatLargeNumberWords(fireball_radius)}<br>
            <span><b>Duration:</b></span> ${fireball_duration.toFixed(2)} seconds<br>
            <span><b>Peak Temperature:</b></span> ${formatLargeNumberWords(fireball_temperature)} °C<br>
            <span><b>Thermal Energy:</b></span> ${(E_megatons * 0.35).toFixed(2)} MT
        </div>
        <div>
            <span><b>Brightness:</b></span> ${formatLargeNumberWords((Math.pow(E_megatons, 0.5) * 1000))} times sun<br>
            <span><b>Thermal Flux (1 km):</b></span> ${getThermalFlux(1000).toFixed(1)} J/cm²<br>
            <span><b>Rise Velocity:</b></span> ${(Math.pow(E_megatons, 0.25) * 100).toFixed(0)} m/s<br>
            <span><b>Final Altitude:</b></span> ${(Math.pow(E_megatons, 0.25) * 12).toFixed(1)} km
        </div>
    </div>
    

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">🔥 Thermal Radiation Zones</h3>
            <div style="position: relative; height: 250px; background: radial-gradient(circle, #ffffff 0%, #ff6600 20%, #ff4500 40%, #FFA500 60%, #FFD700 80%, #1a1a2e 100%); border-radius: 8px; overflow: hidden;">
                <svg width="100%" height="100%" viewBox="0 0 400 250" style="position: absolute; top: 0; left: 0;">
                    <!-- Impact point -->
                    <circle cx="200" cy="125" r="5" fill="white" stroke="#ff0000" stroke-width="2"/>
                    
                    <!-- Zone circles -->
                    <circle cx="200" cy="125" r="30" fill="none" stroke="white" stroke-width="2" opacity="0.8"/>
                    <circle cx="200" cy="125" r="60" fill="none" stroke="#ff0000" stroke-width="2" opacity="0.7"/>
                    <circle cx="200" cy="125" r="90" fill="none" stroke="#ff4500" stroke-width="2" opacity="0.6"/>
                    <circle cx="200" cy="125" r="120" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                    <circle cx="200" cy="125" r="150" fill="none" stroke="#FFD700" stroke-width="2" opacity="0.4"/>
                    
                    <!-- Labels -->
                    <text x="200" y="100" text-anchor="middle" fill="black" font-size="10" font-weight="bold">FIREBALL</text>
                    <text x="260" y="125" text-anchor="start" fill="white" font-size="9">3rd Degree</text>
                    <text x="290" y="125" text-anchor="start" fill="white" font-size="9">2nd Degree</text>
                    <text x="320" y="125" text-anchor="start" fill="white" font-size="9">1st Degree</text>
                </svg>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
                Thermal radiation zones from impact point (overhead view)
            </p>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #8B0000 0%, #ff0000 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: white;">🩹 Burn Injury Zones</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">🔥 Third-Degree Burns (Full Thickness)</h4>
                <b>Radius:</b> ${(third_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> >10 J/cm²<br>
                <b>Effects:</b> Complete destruction of skin layers, nerve endings destroyed (initially painless), charring, requires skin grafts, life-threatening<br>
                <b>Clothing:</b> Ignites immediately<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_3rd)} people
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">🔥 Second-Degree Burns (Partial Thickness)</h4>
                <b>Radius:</b> ${(second_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> 5-10 J/cm²<br>
                <b>Effects:</b> Blistering, severe pain, destruction of epidermis and part of dermis, permanent scarring likely, high infection risk<br>
                <b>Clothing:</b> Synthetic fabrics melt, cotton smolders<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_2nd)} people
            </div>
            <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
                <h4 style="margin: 0 0 8px 0; color: #fff;">🔥 First-Degree Burns (Superficial)</h4>
                <b>Radius:</b> ${(first_degree_radius/1000).toFixed(2)} km<br>
                <b>Thermal Flux:</b> 2.5-5 J/cm²<br>
                <b>Effects:</b> Redness, pain, swelling, similar to severe sunburn, heals without scarring in 3-7 days<br>
                <b>Clothing:</b> Darkening and scorching of exposed fabrics<br>
                <b>Est. Casualties:</b> ${formatLargeNumberWords(casualties_1st)} people
            </div>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="thermalZonesChart" height="200"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="thermalFluxChart" height="220"></canvas>
        </div>

        <div class="chart-container" style="margin-bottom: 15px;">
            <canvas id="burnCasualtiesChart" height="200"></canvas>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">🔥 Secondary Fire Effects</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Ignition Zone:</b><br>
                    ${(ignition_radius/1000).toFixed(2)} km radius<br>
                    <span style="font-size: 0.85em; color: #aaa;">Dry vegetation, wood, paper ignite spontaneously</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Firestorm Potential:</b><br>
                    ${E_megatons > 1 ? 'HIGH' : 'MODERATE'}<br>
                    <span style="font-size: 0.85em; color: #aaa;">Self-sustaining fire consuming oxygen</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Smoke Plume:</b><br>
                    ${(Math.pow(E_megatons, 0.25) * 15).toFixed(1)} km altitude<br>
                    <span style="font-size: 0.85em; color: #aaa;">Blocks sunlight, temperature drop</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Fire Duration:</b><br>
                    ${(Math.sqrt(E_megatons) * 2).toFixed(1)} hours to days<br>
                    <span style="font-size: 0.85em; color: #aaa;">Depending on fuel availability</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #FFD700;">👁️ Flash Blindness & Eye Damage</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b style="color: #FFD700;">Flash Blindness Radius:</b> ${(flash_blindness_radius/1000).toFixed(2)} km<br>
                <b style="color: #FFD700;">Duration of Flash:</b> ${fireball_duration.toFixed(2)} seconds<br>
                <b style="color: #FFD700;">Peak Brightness:</b> ${(Math.pow(E_megatons, 0.5) * 1000).toExponential(2)} times brighter than sun<br>
                <b style="color: #FFD700;">Effects:</b>
                <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.6;">
                    <li>Temporary blindness lasting ${(fireball_duration * 20).toFixed(0)}-${(fireball_duration * 40).toFixed(0)} minutes</li>
                    <li>Permanent retinal damage if looking directly at fireball</li>
                    <li>Retinal burns from distances up to ${(flash_blindness_radius/1000 * 0.3).toFixed(0)} km</li>
                    <li>Night vision impairment for hours after exposure</li>
                    <li>Animals blinded and disoriented across affected zone</li>
                </ul>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #2d1810 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">💡 Thermal Radiation Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>Thermal radiation travels at the speed of light - no warning before exposure</li>
                <li>The flash occurs before the blast wave arrives, giving false sense of safety</li>
                <li>Light-colored, loose-fitting clothing provides better protection than dark, tight fabrics</li>
                <li>Being indoors or behind any barrier significantly reduces thermal effects</li>
                <li>Shadows provide complete protection - anyone shielded escapes direct thermal radiation</li>
                <li>The "double flash" phenomenon: initial flash, brief dimming, then sustained fireball glow</li>
                <li>Thermal pulse can ignite fires that spread beyond the initial burn zone</li>
                <li>At night, the flash can temporarily blind observers hundreds of kilometers away</li>
                <li>Reflective surfaces can redirect thermal radiation to create unexpected burn patterns</li>
            </ul>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #ff4500 0%, #ff6600 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">🏥 Medical Response Requirements</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                <b>Total Burn Casualties:</b> ${formatLargeNumberWords(casualties_1st + casualties_2nd + casualties_3rd)} people<br>
                <b>Critical (3rd degree):</b> ${formatLargeNumberWords(casualties_3rd)} requiring immediate intensive care<br>
                <b>Severe (2nd degree):</b> ${formatLargeNumberWords(casualties_2nd)} requiring hospitalization<br>
                <b>Moderate (1st degree):</b> ${formatLargeNumberWords(casualties_1st)} requiring outpatient treatment<br><br>
                <b style="color: #ffff00;">Hospital beds needed:</b> ${formatLargeNumberWords(casualties_3rd + casualties_2nd * 0.5)}<br>
                <b style="color: #ffff00;">Burn units required:</b> ${Math.ceil(casualties_3rd / 20)} specialized facilities<br>
                <b style="color: #ffff00;">Medical personnel:</b> ${formatLargeNumberWords((casualties_3rd + casualties_2nd) * 2)} doctors and nurses
            </div>
        </div>

        <div class="info-section" style="background: #2d1810; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #ff6600;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">🛡️ Protection Measures</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.15); padding: 10px; border-radius: 5px;">
                    <b style="color: #FFD700;">✓ Effective Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Being inside buildings</li>
                        <li>Basement or interior rooms</li>
                        <li>Any solid barrier/shadow</li>
                        <li>Light-colored clothing</li>
                        <li>Immediate drop and cover</li>
                    </ul>
                </div>
                <div style="background: rgba(255,0,0,0.15); padding: 10px; border-radius: 5px;">
                    <b style="color: #ff6600;">✗ Inadequate Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Standard sunglasses</li>
                        <li>Vehicle windows (may shatter)</li>
                        <li>Trees and vegetation</li>
                        <li>Water (reflects radiation)</li>
                        <li>Distance alone</li>
                    </ul>
                </div>
            </div>
        </div>
    `;
}

async function initThermalCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4);
    
    function getThermalFlux(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < fireball_radius / 1000) return 1e6;
        
        const thermal_yield_fraction = 0.35;
        const thermal_energy = E_joules * thermal_yield_fraction;
        const flux_at_distance = thermal_energy / (4 * Math.PI * Math.pow(distance_m, 2)) / 10000;
        const absorption_factor = Math.exp(-distance_km / 50);
        
        return flux_at_distance * absorption_factor;
    }
    
    function getDistanceForFlux(target_flux) {
        let low = fireball_radius;
        let high = 1000000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const flux = getThermalFlux(mid);
            
            if (flux > target_flux) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const third_degree_radius = getDistanceForFlux(10);
    const second_degree_radius = getDistanceForFlux(5);
    const first_degree_radius = getDistanceForFlux(2.5);
    const flash_blindness_radius = getDistanceForFlux(0.5);
    
    
    const casualties_3rd = await fetchPopulation(asteroidData.lat, asteroidData.lon, third_degree_radius/1000);
    const casualties_2nd = await fetchPopulation(asteroidData.lat, asteroidData.lon, second_degree_radius/1000);
    const casualties_1st = await fetchPopulation(asteroidData.lat, asteroidData.lon, first_degree_radius/1000);


    // Chart 1: Thermal Zone Radii
    new Chart(document.getElementById('thermalZonesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Fireball', '3rd Degree Burns', '2nd Degree Burns', '1st Degree Burns', 'Flash Blindness'],
            datasets: [{
                label: 'Zone Radius (km)',
                data: [
                    fireball_radius / 1000,
                    third_degree_radius / 1000,
                    second_degree_radius / 1000,
                    first_degree_radius / 1000,
                    flash_blindness_radius / 1000
                ],
                backgroundColor: ['#FFFFFF', '#8B0000', '#FF4500', '#FFA500', '#FFD700'],
                borderColor: '#654321',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Thermal Effect Zones',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Radius (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Thermal Flux vs Distance
    const distances = [];
    const fluxes = [];
    for (let d = fireball_radius; d <= flash_blindness_radius * 1.5; d += (flash_blindness_radius * 1.5 - fireball_radius) / 50) {
        distances.push((d / 1000).toFixed(2));
        fluxes.push(getThermalFlux(d));
    }
    
    new Chart(document.getElementById('thermalFluxChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Thermal Flux (J/cm²)',
                data: fluxes,
                borderColor: '#ff6600',
                backgroundColor: 'rgba(255, 102, 0, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Thermal Radiation Intensity vs Distance',
                    color: 'white',
                    font: { size: 14 }
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: 10,
                            yMax: 10,
                            borderColor: '#8B0000',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '3rd Degree',
                                enabled: true,
                                position: 'end'
                            }
                        },
                        line2: {
                            type: 'line',
                            yMin: 5,
                            yMax: 5,
                            borderColor: '#FF4500',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '2nd Degree',
                                enabled: true,
                                position: 'end'
                            }
                        },
                        line3: {
                            type: 'line',
                            yMin: 2.5,
                            yMax: 2.5,
                            borderColor: '#FFA500',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: '1st Degree',
                                enabled: true,
                                position: 'end'
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Thermal Flux (J/cm², log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 10
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Burn Casualties by Type
    new Chart(document.getElementById('burnCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['3rd Degree (Critical)', '2nd Degree (Severe)', '1st Degree (Moderate)'],
            datasets: [{
                data: [casualties_3rd, casualties_2nd, casualties_1st],
                backgroundColor: ['#8B0000', '#FF4500', '#FFA500'],
                borderColor: '#1a1a2e',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Estimated Burn Casualties by Severity',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


// ------------------ SEISMIC MAP ------------------
function showSeismicMap() {
    if (!asteroidData) return;


    
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }

     if (!willAsteroidReachGround(asteroidData)){
        return
     }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Calculate seismic magnitude using empirical relationships
    // Richter magnitude formula: M = 0.67 * log10(E) - 5.87 (E in joules)
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    
    // Modified Mercalli Intensity (MMI) at distance
    // Based on attenuation: MMI = a - b*log10(distance_km)
    function getMMI(distance_km) {
        if (distance_km < 1) return 12; // Extreme - beyond scale
        
        // Empirical formula for MMI attenuation
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        
        return Math.max(1, Math.min(12, mmi));
    }
    
    // Calculate distance for specific MMI levels
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000; // Convert to meters
    }
    
    // Define seismic intensity zones (MMI scale)
    const zones = [
        {
            radius: getDistanceForMMI(10),
            color: '#8B0000',
            label: '🏚️ MMI X - Extreme',
            fillOpacity: 0.8,
            details: `Radius: ${(getDistanceForMMI(10)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(10)/1000).toFixed(1)}<br>Most buildings destroyed, ground cracks, landslides widespread`
        },
        {
            radius: getDistanceForMMI(9),
            color: '#CD5C5C',
            label: '🌋 MMI IX - Violent',
            fillOpacity: 0.65,
            details: `Radius: ${(getDistanceForMMI(9)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(9)/1000).toFixed(1)}<br>General panic, buildings shifted off foundations, ground cracks`
        },
        {
            radius: getDistanceForMMI(8),
            color: '#FF6347',
            label: '🏢 MMI VIII - Severe',
            fillOpacity: 0.5,
            details: `Radius: ${(getDistanceForMMI(8)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(8)/1000).toFixed(1)}<br>Considerable damage to ordinary buildings, chimneys fall`
        },
        {
            radius: getDistanceForMMI(7),
            color: '#FFA500',
            label: '🏠 MMI VII - Very Strong',
            fillOpacity: 0.4,
            details: `Radius: ${(getDistanceForMMI(7)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(7)/1000).toFixed(1)}<br>Damage to poorly built structures, felt by everyone`
        },
        {
            radius: getDistanceForMMI(6),
            color: '#FFD700',
            label: '⚠️ MMI VI - Strong',
            fillOpacity: 0.3,
            details: `Radius: ${(getDistanceForMMI(6)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(6)/1000).toFixed(1)}<br>Felt by all, minor damage, objects fall`
        },
        {
            radius: getDistanceForMMI(5),
            color: '#FFFF00',
            label: '📊 MMI V - Moderate',
            fillOpacity: 0.2,
            details: `Radius: ${(getDistanceForMMI(5)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(5)/1000).toFixed(1)}<br>Felt by most, sleeping people awakened`
        },
        {
            radius: getDistanceForMMI(4),
            color: '#ADFF2F',
            label: '🔔 MMI IV - Light',
            fillOpacity: 0.15,
            details: `Radius: ${(getDistanceForMMI(4)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(4)/1000).toFixed(1)}<br>Felt indoors, windows rattle`
        },
        {
            radius: getDistanceForMMI(3),
            color: '#98FB98',
            label: '👥 MMI III - Weak',
            fillOpacity: 0.1,
            details: `Radius: ${(getDistanceForMMI(3)/1000).toFixed(0)} km<br>Magnitude felt: ${getMMI(getDistanceForMMI(3)/1000).toFixed(1)}<br>Felt by some people, like passing truck`
        }
    ];
    
    // Sort by radius (largest first) and draw
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #8B0000; box-shadow: 0 0 20px rgba(255,0,0,1), 0 0 40px rgba(139,0,0,0.8);"></div>',
            iconSize: [24, 24]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Seismic Epicenter</b><br>
        Magnitude: ${seismic_magnitude.toFixed(1)} (Richter)<br>
        Energy: ${E_megatons.toFixed(2)} MT<br>
        Ground acceleration: >1g<br>
        Duration: ${(Math.pow(E_megatons, 0.33) * 10).toFixed(0)} seconds
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show seismic zones (limit to MMI IV for readability)
    const maxRadius = getDistanceForMMI(4);
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateSeismicContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    
    if (!willAsteroidReachGround(asteroidData)) {
    // Remove previous message if exists
    const oldMessage = document.getElementById("craterMessage");
    if (oldMessage) oldMessage.remove();

    // Create a centered modal
    const messageDiv = document.createElement("div");
    messageDiv.id = "craterMessage";
    messageDiv.style.position = "fixed";
    messageDiv.style.top = "50%";
    messageDiv.style.left = "50%";
    messageDiv.style.transform = "translate(-50%, -50%)";
    messageDiv.style.backgroundColor = "#8B4513"; 
    messageDiv.style.padding = "30px 40px";
    messageDiv.style.borderRadius = "12px";
    messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
    messageDiv.style.textAlign = "center";
    messageDiv.style.zIndex = "9999";
    messageDiv.innerHTML = `
        <h2>💨 Asteroid Breakup</h2>
        <p>The asteroid will disintegrate in the atmosphere.<br><b>No Seismic Activities will happen.</b></p>
        <button id="closeCraterMessage" style="
            margin-top: 15px;
            padding: 8px 15px;
            background: white;
            color: #ff5252;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        ">Close</button>
    `;
    document.body.appendChild(messageDiv);

    // Close button functionality
    document.getElementById("closeCraterMessage").addEventListener("click", () => {
        messageDiv.remove();
    });

    return; // stop execution

    }
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Seismic calculations
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    const seismic_energy_fraction = 0.001; // ~0.1% of impact energy becomes seismic
    const seismic_energy_joules = E_joules * seismic_energy_fraction;
    
    // Ground motion parameters
    const peak_ground_acceleration = Math.pow(E_megatons, 0.5) * 9.81; // m/s² (multiples of g)
    const seismic_duration = Math.pow(E_megatons, 0.33) * 10; // seconds
    
    function getMMI(distance_km) {
        if (distance_km < 1) return 12;
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        return Math.max(1, Math.min(12, mmi));
    }
    
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000;
    }
    
    function getPGA(distance_km) {
        // Peak Ground Acceleration in g's
        // Attenuation formula: PGA = PGA_0 * (R_0 / R)^1.5 * e^(-R/500)
        if (distance_km < 1) return peak_ground_acceleration / 9.81;
        const pga_0 = peak_ground_acceleration / 9.81;
        const pga = pga_0 * Math.pow(10 / distance_km, 1.5) * Math.exp(-distance_km / 500);
        return Math.max(0.001, pga);
    }
    
    function getPGV(distance_km) {
        // Peak Ground Velocity in cm/s
        const pga_g = getPGA(distance_km);
        const pgv = pga_g * 9.81 * 10; // Approximate conversion
        return pgv;
    }
    
    // Calculate seismic wave arrival times
    function getArrivalTime(distance_km) {
        // P-wave velocity ~6 km/s, S-wave velocity ~3.5 km/s
        const p_wave_speed = 6; // km/s
        const s_wave_speed = 3.5; // km/s
        const surface_wave_speed = 3; // km/s
        
        return {
            p_wave: distance_km / p_wave_speed,
            s_wave: distance_km / s_wave_speed,
            surface_wave: distance_km / surface_wave_speed
        };
    }
    
    // Population casualties by MMI zone
    const casualties_mmi_10 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(10)/1000);
    const casualties_mmi_9 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(9)/1000);
    const casualties_mmi_8 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(8)/1000);
    const casualties_mmi_7 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(7)/1000);
    const casualties_mmi_6 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(6)/1000);
    
    // Seismic fatality rates by MMI
    const total_seismic_deaths = Math.floor(
        casualties_mmi_10 * 0.80 +
        (casualties_mmi_9 - casualties_mmi_10) * 0.50 +
        (casualties_mmi_8 - casualties_mmi_9) * 0.20 +
        (casualties_mmi_7 - casualties_mmi_8) * 0.05 +
        (casualties_mmi_6 - casualties_mmi_7) * 0.01
    );
    
    // Compare to historical earthquakes
    const nearest_historical = seismic_magnitude > 9.5 ? "Larger than any recorded earthquake" :
                              seismic_magnitude > 9.0 ? "Similar to 2011 Tohoku earthquake (9.1)" :
                              seismic_magnitude > 8.0 ? "Similar to 1906 San Francisco earthquake (7.9)" :
                              "Comparable to major regional earthquake";
    
    return `
    <style>
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
            z-index: 10000;
        }
        .info-tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: rgba(0,0,0,0.9);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 6px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.5;
            pointer-events: none;
        }
        .info-tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            font-size: 14px;
            opacity: 0.9;
            user-select: none;
        }
        </style>
        


        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: #2c1810; padding: 10px; color: white;">
            <div>
                <span><b>Seismic Magnitude:</b></span> ${seismic_magnitude.toFixed(1)} (Richter)<br>
        
                <span><b>Moment Magnitude:</b></span> ${(seismic_magnitude + 0.3).toFixed(1)} (Mw)
                <span class="info-tooltip" style="position: relative; display: inline-block;">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="
                        width: 180px; 
                        font-size: 12px; 
                        line-height: 1.5;
                        left: 105%;       /* move tooltip to the right of the icon */
                        top: 50%;         /* vertically center */
                        transform: translateY(-50%); /* vertically center */
                        bottom: auto;     /* reset bottom positioning */
                        margin-bottom: 0; 
                    ">
                        Moment Magnitude (Mw) measures the total energy released by an earthquake.
                    </span>
                </span><br>
        
                <span><b>Seismic Energy:</b></span> ${(seismic_energy_joules/4.184e15).toFixed(3)} MT<br>
                <span><b>Total Deaths:</b></span> ${formatLargeNumberWords(total_seismic_deaths)}
            </div>
            <div>
                <span><b>Peak Ground Accel:</b></span> ${(peak_ground_acceleration/9.81).toFixed(1)}g
                <span class="info-tooltip">
                    <span class="info-icon">ℹ️</span>
                    <span class="tooltiptext" style="width: 180px; font-size: 12px; line-height: 1.5;">
                        Peak Ground Acceleration (PGA) indicates the maximum ground shaking during the earthquake.
                    </span>
                </span><br>
        
                <span><b>Duration:</b></span> ${seismic_duration.toFixed(0)} seconds<br>
                <span><b>Historical Compare:</b></span> ${nearest_historical}<br>
                <span><b>Felt Distance:</b></span> ${(getDistanceForMMI(3)/1000).toFixed(0)} km
            </div>
        </div>
        
        <div class="info-section" style="background: linear-gradient(180deg, #2c1810 0%, #4a2c1a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff8c00;">🌍 Seismic Wave Propagation</h3>
            <div style="position: relative; height: 250px; background: radial-gradient(circle, #8B0000 0%, #CD5C5C 15%, #FF6347 30%, #FFA500 50%, #FFD700 70%, #2c1810 100%); border-radius: 8px; overflow: hidden;">
                <svg width="100%" height="100%" viewBox="0 0 400 250" style="position: absolute; top: 0; left: 0;">
                    <!-- Epicenter -->
                    <circle cx="200" cy="125" r="8" fill="#ff0000" stroke="white" stroke-width="2"/>
                    
                    <!-- Seismic waves -->
                    <circle cx="200" cy="125" r="25" fill="none" stroke="#8B0000" stroke-width="3" opacity="0.9"/>
                    <circle cx="200" cy="125" r="50" fill="none" stroke="#CD5C5C" stroke-width="2.5" opacity="0.7"/>
                    <circle cx="200" cy="125" r="75" fill="none" stroke="#FF6347" stroke-width="2" opacity="0.6"/>
                    <circle cx="200" cy="125" r="100" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                    <circle cx="200" cy="125" r="130" fill="none" stroke="#FFD700" stroke-width="1.5" opacity="0.4"/>
                    
                    <!-- Labels -->
                    <text x="200" y="122" text-anchor="middle" fill="white" font-size="10" font-weight="bold">IMPACT</text>
                    <text x="225" y="125" text-anchor="start" fill="white" font-size="9">MMI X</text>
                    <text x="250" y="125" text-anchor="start" fill="white" font-size="9">MMI VIII</text>
                    <text x="275" y="125" text-anchor="start" fill="white" font-size="9">MMI VI</text>
                    <text x="330" y="125" text-anchor="start" fill="#FFD700" font-size="9">MMI IV</text>
                </svg>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
                Seismic intensity zones (Modified Mercalli Intensity scale)
            </p>
        </div>

    <div class="info-section" style="background: linear-gradient(135deg, #8B0000 0%, #CD5C5C 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff8c00;">
        <h3 style="margin: 0 0 10px 0; color: white;">📊 Seismic Intensity Zones (MMI)</h3>
        
        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI X - Extreme (0-${(getDistanceForMMI(10)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Violent, impossible to stand<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(10)/1000/2).toFixed(2)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(10)/1000/2).toFixed(0)} cm/s<br>
            <b>Damage:</b> Most masonry/frame structures destroyed, ground badly cracked, landslides, liquefaction<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_10)} (80% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.35); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI IX - Violent (${(getDistanceForMMI(10)/1000).toFixed(0)}-${(getDistanceForMMI(9)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Violent, general panic<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(9)/1000).toFixed(2)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(9)/1000).toFixed(0)} cm/s<br>
            <b>Damage:</b> Buildings shifted off foundations, considerable ground cracks, pipes broken<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_9 - casualties_mmi_10)} additional (50% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VIII - Severe (${(getDistanceForMMI(9)/1000).toFixed(0)}-${(getDistanceForMMI(8)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Severe, difficult to steer vehicles<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(8)/1000).toFixed(3)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(8)/1000).toFixed(1)} cm/s<br>
            <b>Damage:</b> Considerable damage to ordinary buildings, chimneys fall, sand/mud ejected<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_8 - casualties_mmi_9)} additional (20% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.25); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VII - Very Strong (${(getDistanceForMMI(8)/1000).toFixed(0)}-${(getDistanceForMMI(7)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Very strong, difficult to stand<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(7)/1000).toFixed(3)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(7)/1000).toFixed(1)} cm/s<br>
            <b>Damage:</b> Damage to poorly built structures, noticed by drivers, waves on ponds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_7 - casualties_mmi_8)} additional (5% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI VI - Strong (${(getDistanceForMMI(7)/1000).toFixed(0)}-${(getDistanceForMMI(6)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Strong, felt by all<br>
            <b>PGA:</b> ${getPGA(getDistanceForMMI(6)/1000).toFixed(4)}g<br>
            <b>PGV:</b> ${getPGV(getDistanceForMMI(6)/1000).toFixed(2)} cm/s<br>
            <b>Damage:</b> Books fall, pictures knocked off walls, plaster cracks, minor damage<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_mmi_6 - casualties_mmi_7)} additional (1% fatality)
        </div>
        
        <div style="background: rgba(0,0,0,0.15); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">MMI V and Below (>${(getDistanceForMMI(6)/1000).toFixed(0)} km)</h4>
            <b>Shaking:</b> Moderate to weak<br>
            <b>Damage:</b> Minimal to none, felt by people but little structural impact<br>
            <b>Distance Range:</b> Felt up to ${(getDistanceForMMI(3)/1000).toFixed(0)} km away
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="seismicIntensityChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="groundMotionChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="seismicCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">🌊 Seismic Wave Types</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em;">
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">P-Waves (Primary)</b><br>
                Speed: 6 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Compression waves, arrive first, least damaging</span>
            </div>
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">S-Waves (Secondary)</b><br>
                Speed: 3.5 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Shear waves, more destructive, cannot travel through liquid</span>
            </div>
            <div style="background: rgba(255,140,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff8c00;">
                <b style="color: #ff8c00;">Surface Waves</b><br>
                Speed: 3 km/s<br>
                <span style="font-size: 0.85em; color: #aaa;">Love & Rayleigh waves, most destructive, cause rolling motion</span>
            </div>
        </div>
        
        <h4 style="margin: 15px 0 10px 0; color: #ff8c00;">Wave Arrival Times</h4>
        <div style="font-size: 0.9em; line-height: 1.8;">
            <b>At 100 km:</b> P-wave ${getArrivalTime(100).p_wave.toFixed(1)}s, S-wave ${getArrivalTime(100).s_wave.toFixed(1)}s, Surface ${getArrivalTime(100).surface_wave.toFixed(1)}s<br>
            <b>At 500 km:</b> P-wave ${(getArrivalTime(500).p_wave/60).toFixed(1)}min, S-wave ${(getArrivalTime(500).s_wave/60).toFixed(1)}min, Surface ${(getArrivalTime(500).surface_wave/60).toFixed(1)}min<br>
            <b>At 1000 km:</b> P-wave ${(getArrivalTime(1000).p_wave/60).toFixed(1)}min, S-wave ${(getArrivalTime(1000).s_wave/60).toFixed(1)}min, Surface ${(getArrivalTime(1000).surface_wave/60).toFixed(1)}min
        </div>
    </div>

    <div class="info-section" style="background: #2c1810; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">⚠️ Secondary Seismic Effects</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
            <li><b>Liquefaction:</b> Saturated soil loses strength, buildings sink, radius ${(getDistanceForMMI(8)/1000 * 0.8).toFixed(0)} km</li>
            <li><b>Landslides:</b> Massive slope failures in mountainous areas, radius ${(getDistanceForMMI(7)/1000).toFixed(0)} km</li>
            <li><b>Ground Rupture:</b> Surface faulting and cracks up to ${(Math.pow(E_megatons, 0.4) * 5).toFixed(1)} meters wide</li>
            <li><b>Aftershocks:</b> ${Math.floor(Math.log10(E_megatons) * 100)} aftershocks over weeks, magnitude ${(seismic_magnitude - 1.2).toFixed(1)} to ${(seismic_magnitude - 0.5).toFixed(1)}</li>
            <li><b>Seiches:</b> Standing waves in lakes/reservoirs, potential dam failures</li>
            <li><b>Infrastructure Damage:</b> Pipeline breaks, bridge collapses, road buckling within ${(getDistanceForMMI(7)/1000).toFixed(0)} km</li>
            <li><b>Fire Following:</b> Gas line ruptures ignite widespread fires, compounded by broken water mains</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #4a2c1a 0%, #6d4c3d 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">📈 Historical Earthquake Comparison</h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,140,0,0.2); border-bottom: 2px solid #ff8c00;">
                    <th style="padding: 8px; text-align: left;">Event</th>
                    <th style="padding: 8px; text-align: center;">Magnitude</th>
                    <th style="padding: 8px; text-align: center;">Deaths</th>
                    <th style="padding: 8px; text-align: left;">Comparison</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">This Impact</td>
                    <td style="padding: 8px; text-align: center;">${seismic_magnitude.toFixed(1)}</td>
                    <td style="padding: 8px; text-align: center;">${formatLargeNumberWords(total_seismic_deaths)}</td>
                    <td style="padding: 8px;">${nearest_historical}</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">1960 Chile</td>
                    <td style="padding: 8px; text-align: center;">9.5</td>
                    <td style="padding: 8px; text-align: center;">1,655</td>
                    <td style="padding: 8px;">Largest recorded earthquake</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">2011 Tohoku, Japan</td>
                    <td style="padding: 8px; text-align: center;">9.1</td>
                    <td style="padding: 8px; text-align: center;">15,899</td>
                    <td style="padding: 8px;">Triggered devastating tsunami</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">2010 Haiti</td>
                    <td style="padding: 8px; text-align: center;">7.0</td>
                    <td style="padding: 8px; text-align: center;">316,000</td>
                    <td style="padding: 8px;">Deadliest recent earthquake</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">1906 San Francisco</td>
                    <td style="padding: 8px; text-align: center;">7.9</td>
                    <td style="padding: 8px; text-align: center;">3,000+</td>
                    <td style="padding: 8px;">Historic California quake</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: white;">🚑 Seismic Casualty Summary</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                ${formatLargeNumberWords(total_seismic_deaths)} Deaths
            </div>
            <div style="font-size: 0.95em; line-height: 1.7;">
                <b>Primary Causes of Seismic Death:</b>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li>Building collapse (60%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.60))} people</li>
                    <li>Landslides and rockfalls (15%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.15))} people</li>
                    <li>Infrastructure failure (10%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.10))} people</li>
                    <li>Fire following earthquake (10%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.10))} people</li>
                    <li>Other causes (5%): ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 0.05))} people</li>
                </ul>
                <b>Injured (non-fatal):</b> ${formatLargeNumberWords(Math.floor(total_seismic_deaths * 3))} additional casualties<br>
                <b>Displaced:</b> ${formatLargeNumberWords(casualties_mmi_7)} people lose homes
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">🏗️ Building Damage by Construction Type</h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,140,0,0.2); border-bottom: 2px solid #ff8c00;">
                    <th style="padding: 8px; text-align: left;">Building Type</th>
                    <th style="padding: 8px; text-align: center;">MMI VII</th>
                    <th style="padding: 8px; text-align: center;">MMI VIII</th>
                    <th style="padding: 8px; text-align: center;">MMI IX+</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Wood Frame Houses</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                    <td style="padding: 8px; text-align: center;">Destroyed</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Unreinforced Masonry</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                    <td style="padding: 8px; text-align: center;">Destroyed</td>
                    <td style="padding: 8px; text-align: center;">Collapsed</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Reinforced Concrete</td>
                    <td style="padding: 8px; text-align: center;">Light</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy/Destroyed</td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Steel Frame</td>
                    <td style="padding: 8px; text-align: center;">Light</td>
                    <td style="padding: 8px; text-align: center;">Moderate</td>
                    <td style="padding: 8px; text-align: center;">Heavy</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #ff8c00;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">💡 Seismic Facts</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
            <li>Seismic waves travel through the entire planet - detectable globally by seismometers</li>
            <li>The shaking duration increases with magnitude - this impact produces ${seismic_duration.toFixed(0)} seconds of intense shaking</li>
            <li>Soft soil amplifies ground motion by 2-4x compared to bedrock</li>
            <li>Resonance effects can cause specific buildings to shake violently even at lower intensities</li>
            <li>Most earthquake deaths occur from building collapse, not ground shaking itself</li>
            <li>Modern seismic building codes can reduce casualties by >90% at the same intensity</li>
            <li>P-waves provide seconds to minutes of warning before destructive S-waves arrive</li>
            <li>The "triangle of life" (doorways) is a myth - "drop, cover, hold on" is correct procedure</li>
            <li>Aftershocks can continue for months, some nearly as strong as the main event</li>
            <li>Seismic energy released is ${(Math.pow(10, 1.5 * seismic_magnitude + 4.8) / 4.184e15).toFixed(1)} times the Hiroshima bomb</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #27ae60;">
        <h3 style="margin: 0 0 10px 0; color: white;">🛡️ Earthquake Survival Guide</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">✓ During Shaking:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>DROP to hands and knees</li>
                    <li>COVER head/neck under desk</li>
                    <li>HOLD ON until shaking stops</li>
                    <li>Stay away from windows</li>
                    <li>If in bed, stay there with pillow</li>
                </ul>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">✓ After Shaking:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Check for injuries</li>
                    <li>Expect aftershocks</li>
                    <li>Check gas/water/electric</li>
                    <li>Stay away from damaged buildings</li>
                    <li>Have emergency supplies ready</li>
                </ul>
            </div>
            <div style="background: rgba(192,57,43,0.3); padding: 10px; border-radius: 5px;">
                <b style="color: white;">✗ Dangerous Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Running outside (falling debris)</li>
                    <li>Standing in doorways (no longer safe)</li>
                    <li>Using elevators</li>
                    <li>Lighting matches (gas leaks)</li>
                    <li>Returning to damaged buildings</li>
                </ul>
            </div>
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                <b style="color: white;">⚠️ Special Situations:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>In car: Stop, stay inside</li>
                    <li>Outdoors: Move away from buildings</li>
                    <li>In stadium: Stay, don't rush exits</li>
                    <li>Near coast: Move to high ground</li>
                    <li>In mountains: Watch for landslides</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #34495e; padding: 15px; border-radius: 8px; margin-top: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #ff8c00;">🌍 Global Seismic Impact</h3>
        <div style="font-size: 0.9em; line-height: 1.8;">
            <b>Detectable Distance:</b> ${(getDistanceForMMI(1)/1000).toFixed(0)} km (global seismograph detection)<br>
            <b>Felt by Humans:</b> Up to ${(getDistanceForMMI(3)/1000).toFixed(0)} km away<br>
            <b>Structural Damage:</b> Within ${(getDistanceForMMI(6)/1000).toFixed(0)} km<br>
            <b>Energy Released:</b> ${(seismic_energy_joules/4.184e15).toFixed(3)} megatons (seismic only)<br>
            <b>Equivalent TNT:</b> ${(seismic_energy_joules/4.184e9).toFixed(0)} tons<br>
            <b>Hiroshima Bombs:</b> ${(seismic_energy_joules/(63e12)).toFixed(0)} (15 kiloton equivalent)<br>
            <b>Duration of Shaking:</b> ${seismic_duration.toFixed(0)} seconds at epicenter
        </div>
    </div>
    `;
}

async function initSeismicCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const seismic_magnitude = 0.67 * Math.log10(E_joules) - 5.87;
    
    function getMMI(distance_km) {
        if (distance_km < 1) return 12;
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const mmi = a - b * Math.log10(distance_km);
        return Math.max(1, Math.min(12, mmi));
    }
    
    function getDistanceForMMI(target_mmi) {
        const a = seismic_magnitude * 1.5 + 1.5;
        const b = 3.5;
        const distance_km = Math.pow(10, (a - target_mmi) / b);
        return distance_km * 1000;
    }
    
    function getPGA(distance_km) {
        if (distance_km < 1) return Math.pow(E_megatons, 0.5);
        const peak_ground_acceleration = Math.pow(E_megatons, 0.5) * 9.81;
        const pga_0 = peak_ground_acceleration / 9.81;
        const pga = pga_0 * Math.pow(10 / distance_km, 1.5) * Math.exp(-distance_km / 500);
        return Math.max(0.001, pga);
    }
    
    const casualties_mmi_10 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(10)/1000);
    const casualties_mmi_9 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(9)/1000);
    const casualties_mmi_8 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(8)/1000);
    const casualties_mmi_7 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(7)/1000);
    const casualties_mmi_6 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(6)/1000);
    const casualties_mmi_5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, getDistanceForMMI(5)/1000);
    
    // Chart 1: Seismic Intensity vs Distance
    new Chart(document.getElementById('seismicIntensityChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['MMI X', 'MMI IX', 'MMI VIII', 'MMI VII', 'MMI VI', 'MMI V'],
            datasets: [{
                label: 'Distance (km)',
                data: [
                    getDistanceForMMI(10) / 1000,
                    getDistanceForMMI(9) / 1000,
                    getDistanceForMMI(8) / 1000,
                    getDistanceForMMI(7) / 1000,
                    getDistanceForMMI(6) / 1000,
                    getDistanceForMMI(5) / 1000
                ],
                backgroundColor: ['#8B0000', '#CD5C5C', '#FF6347', '#FFA500', '#FFD700', '#FFFF00'],
                borderColor: '#ff8c00',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Seismic Intensity Zones (Modified Mercalli)',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Ground Motion (PGA) vs Distance
    const distances = [];
    const pgaValues = [];
    
    for (let d = 1; d <= 2000; d += 20) {
        distances.push(d);
        pgaValues.push(getPGA(d));
    }
    
    new Chart(document.getElementById('groundMotionChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Peak Ground Acceleration (g)',
                data: pgaValues,
                borderColor: '#ff8c00',
                backgroundColor: 'rgba(255,140,0,0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Peak Ground Acceleration vs Distance',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'PGA (g, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Epicenter',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Population Exposure by MMI Zone
    new Chart(document.getElementById('seismicCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['MMI X', 'MMI IX', 'MMI VIII', 'MMI VII', 'MMI VI', 'MMI V'],
            datasets: [{
                data: [
                    casualties_mmi_10,
                    casualties_mmi_9 - casualties_mmi_10,
                    casualties_mmi_8 - casualties_mmi_9,
                    casualties_mmi_7 - casualties_mmi_8,
                    casualties_mmi_6 - casualties_mmi_7,
                    casualties_mmi_5 - casualties_mmi_6
                ],
                backgroundColor: ['#8B0000', '#CD5C5C', '#FF6347', '#FFA500', '#FFD700', '#FFFF00'],
                borderColor: '#2c1810',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Population Exposure by Seismic Intensity',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} people (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


function showWaterMap() {
    const isOverWater = asteroidSession.is_tsunami;  // notice the underscore

    if (!asteroidData) return;
    if (!isOverWater)
    {
        return
    }
    if(!willAsteroidReachGround(asteroidData)){
        return;
    }
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    
    currentMapLayer = L.layerGroup();
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Water depth at impact location (assume ocean depth)
    const ocean_depth = 4000; // meters, average ocean depth
    const g = 9.81;
    
    // Calculate tsunami wave characteristics
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50; // meters
    const wave_period = 2 * Math.PI * Math.sqrt(ocean_depth / g); // seconds
    const tsunami_speed = Math.sqrt(g * ocean_depth); // m/s (~200 m/s in deep ocean)
    
    // Calculate wave heights at different distances
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        
        return amplitude * friction_loss;
    }
    
    // Calculate coastal wave amplification (shoaling effect)
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    // Define tsunami zones based on wave heights
    const mega_tsunami_radius = 50000; // 50 km
    const major_tsunami_radius = 200000; // 200 km
    const moderate_tsunami_radius = 500000; // 500 km
    const minor_tsunami_radius = 1000000; // 1000 km
    const detectable_radius = 2000000; // 2000 km
    
    const zones = [
        {
            radius: mega_tsunami_radius,
            color: '#000080',
            label: '🌊 Mega-Tsunami Zone',
            fillOpacity: 0.85,
            details: `Radius: ${(mega_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(mega_tsunami_radius).toFixed(0)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(mega_tsunami_radius)).toFixed(0)}m<br>Complete coastal devastation`
        },
        {
            radius: major_tsunami_radius,
            color: '#0000CD',
            label: '🌊 Major Tsunami Zone',
            fillOpacity: 0.65,
            details: `Radius: ${(major_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(major_tsunami_radius).toFixed(0)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(major_tsunami_radius)).toFixed(0)}m<br>Severe coastal destruction`
        },
        {
            radius: moderate_tsunami_radius,
            color: '#4169E1',
            label: '🌊 Moderate Tsunami Zone',
            fillOpacity: 0.45,
            details: `Radius: ${(moderate_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(moderate_tsunami_radius).toFixed(1)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(moderate_tsunami_radius)).toFixed(0)}m<br>Major coastal damage`
        },
        {
            radius: minor_tsunami_radius,
            color: '#87CEEB',
            label: '🌊 Minor Tsunami Zone',
            fillOpacity: 0.3,
            details: `Radius: ${(minor_tsunami_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(minor_tsunami_radius).toFixed(1)}m (Deep)<br>Coastal Height: ${getCoastalWaveHeight(getTsunamiHeight(minor_tsunami_radius)).toFixed(1)}m<br>Coastal flooding and damage`
        },
        {
            radius: detectable_radius,
            color: '#B0E0E6',
            label: '📊 Detectable Wave Zone',
            fillOpacity: 0.15,
            details: `Radius: ${(detectable_radius/1000).toFixed(0)} km<br>Wave Height: ${getTsunamiHeight(detectable_radius).toFixed(2)}m<br>Observable by instruments<br>Minor coastal effects`
        }
    ];
    
    // Sort and draw zones
    zones.sort((a, b) => b.radius - a.radius);
    
    zones.forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(currentMapLayer)
          .bindPopup(`<b>${zone.label}</b><br>${zone.details}`);
    });
    
    // Add impact point marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #1E90FF; width: 24px; height: 24px; border-radius: 50%; border: 3px solid #000080; box-shadow: 0 0 20px rgba(30,144,255,1), 0 0 40px rgba(0,0,255,0.8);"></div>',
            iconSize: [24, 24]
        })
    }).addTo(currentMapLayer).bindPopup(`
        <b>Ocean Impact Point</b><br>
        Initial Wave: ${initial_amplitude.toFixed(0)}m<br>
        Tsunami Speed: ${(tsunami_speed * 3.6).toFixed(0)} km/h<br>
        Wave Period: ${wave_period.toFixed(0)} seconds<br>
        Ocean Depth: ${ocean_depth}m
    `);
    
    currentMapLayer.addTo(mainMap);
    
    // Fit bounds to show tsunami zones
    const maxRadius = detectable_radius;
    mainMap.fitBounds([
        [asteroidData.lat - maxRadius/111320, asteroidData.lon - maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))],
        [asteroidData.lat + maxRadius/111320, asteroidData.lon + maxRadius/(111320*Math.cos(asteroidData.lat*Math.PI/180))]
    ]);
}

async function generateWaterContent() {
    if (!asteroidData) return "<p>Loading data...</p>";

    if (!willAsteroidReachGround(asteroidData)) {
        // Remove previous message if exists
        const oldMessage = document.getElementById("waterImpactMessage");
        if (oldMessage) oldMessage.remove();
    
        // Create a centered modal
        const messageDiv = document.createElement("div");
        messageDiv.id = "waterImpactMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#2196F3"; // Blue for water
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>🌊 Water Impact</h2>
            <p>The asteroid will explode in the atmosphere.</p>
            <button id="closeWaterMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #2196F3;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        document.body.appendChild(messageDiv);
    
        // Close button functionality
        document.getElementById("closeWaterMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
    
        return; // stop execution
    }



    // Check if impact is over water (simplified - you'd use actual ocean data)
    const isOverWater = asteroidSession.is_tsunami;  // notice the underscore
    
    if (!isOverWater) {
        const messageDiv = document.createElement("div");
        messageDiv.id = "waterMessage";
        messageDiv.style.cssText = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #2196F3; color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; z-index: 9999;";
        messageDiv.innerHTML = `
            <h2>🏜️ Land Impact</h2>
            <p>The asteroid will impact on land.<br><b>Water effects analysis not applicable.</b></p>
            <button onclick="this.parentElement.remove()" style="margin-top: 15px; padding: 8px 15px; background: white; color: #2196F3; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Close</button>
        `;
        document.body.appendChild(messageDiv);
        return;
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Ocean parameters
    const ocean_depth = 4000;
    const g = 9.81;
    const water_density = 1025; // kg/m³ seawater
    
    // Crater and cavity calculations
    const transient_crater_diameter = 2.68 * Math.pow(E_megatons / 1000, 0.3) * 1000; // meters
    const cavity_depth = transient_crater_diameter * 0.3;
    const water_displacement = Math.PI * Math.pow(transient_crater_diameter/2, 2) * cavity_depth;
    const displaced_mass = water_displacement * water_density;
    
    // Tsunami calculations
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50;
    const tsunami_speed = Math.sqrt(g * ocean_depth);
    const wave_period = 2 * Math.PI * Math.sqrt(ocean_depth / g);
    
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        return amplitude * friction_loss;
    }
    
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    function getArrivalTime(distance_m) {
        return distance_m / tsunami_speed / 60; // minutes
    }
    
    // Population exposure
    const mega_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 50);
    const major_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 200);
    const moderate_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 500);
    const minor_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 1000);
    
    // Steam and aerosol calculations
    const water_vaporized = (E_joules * 0.1) / 2.26e6; // kg
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background-color: #001f3f; padding: 10px; color: white;">
        <div>
            <span><b>Impact Energy:</b></span> ${E_megatons.toFixed(2)} MT<br>
            <span><b>Ocean Depth:</b></span> ${ocean_depth.toLocaleString()} m<br>
            <span><b>Tsunami Speed:</b></span> ${(tsunami_speed * 3.6).toFixed(0)} km/h<br>
            <span><b>Wave Period:</b></span> ${wave_period.toFixed(0)} seconds
        </div>
        <div>
            <span><b>Initial Wave Height:</b></span> ${initial_amplitude.toFixed(0)} m<br>
            <span><b>Cavity Diameter:</b></span> ${(transient_crater_diameter/1000).toFixed(2)} km<br>
            <span><b>Water Displaced:</b></span> ${(water_displacement/1e9).toFixed(2)} km³<br>
            <span><b>Displaced Mass:</b></span> ${(displaced_mass/1e12).toFixed(2)} trillion kg
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(180deg, #001f3f 0%, #003366 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">🌊 Tsunami Wave Propagation</h3>
        <div style="position: relative; height: 200px; background: linear-gradient(180deg, #87CEEB 0%, #4169E1 50%, #000080 100%); border-radius: 8px; overflow: hidden;">
            <svg width="100%" height="100%" viewBox="0 0 400 200" style="position: absolute; top: 0; left: 0;">
                <circle cx="200" cy="100" r="8" fill="#FF0000" stroke="#FFFFFF" stroke-width="2"/>
                <circle cx="200" cy="100" r="30" fill="none" stroke="white" stroke-width="3" opacity="0.9"/>
                <circle cx="200" cy="100" r="60" fill="none" stroke="#4169E1" stroke-width="2" opacity="0.7"/>
                <circle cx="200" cy="100" r="90" fill="none" stroke="#87CEEB" stroke-width="2" opacity="0.5"/>
                <circle cx="200" cy="100" r="120" fill="none" stroke="#B0E0E6" stroke-width="1" opacity="0.3"/>
                <text x="200" y="95" text-anchor="middle" fill="white" font-size="10" font-weight="bold">IMPACT</text>
                <text x="230" y="100" text-anchor="start" fill="white" font-size="9">50 km</text>
                <text x="260" y="100" text-anchor="start" fill="white" font-size="9">200 km</text>
                <text x="290" y="100" text-anchor="start" fill="#E0E0E0" font-size="9">500 km</text>
            </svg>
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #000080 0%, #1E90FF 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4169E1;">
        <h3 style="margin: 0 0 10px 0; color: white;">🌊 Tsunami Zones & Wave Heights</h3>
        
        <div style="background: rgba(0,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Mega-Tsunami Zone (0-50 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(25000).toFixed(0)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(25000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(50000).toFixed(0)} minutes<br>
            <b>Effects:</b> Complete annihilation of coastal regions, waves overtop mountains, total infrastructure destruction<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(mega_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Major Tsunami Zone (50-200 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(100000).toFixed(0)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(100000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(200000).toFixed(0)} minutes<br>
            <b>Effects:</b> Massive coastal devastation, inland flooding up to 10 km, port cities destroyed<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(major_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Moderate Tsunami Zone (200-500 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(350000).toFixed(1)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(350000)).toFixed(0)} m<br>
            <b>Arrival Time:</b> ${getArrivalTime(500000).toFixed(0)} minutes (${(getArrivalTime(500000)/60).toFixed(1)} hours)<br>
            <b>Effects:</b> Severe coastal flooding, harbor damage, evacuations required<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(moderate_casualties)} people
        </div>
        
        <div style="background: rgba(0,0,0,0.1); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">Minor Tsunami Zone (500-1000 km)</h4>
            <b>Deep Water Height:</b> ${getTsunamiHeight(750000).toFixed(1)} m<br>
            <b>Coastal Height:</b> ${getCoastalWaveHeight(getTsunamiHeight(750000)).toFixed(1)} m<br>
            <b>Arrival Time:</b> ${(getArrivalTime(1000000)/60).toFixed(1)} hours<br>
            <b>Effects:</b> Coastal flooding, boat damage, beach erosion<br>
            <b>Est. Affected:</b> ${formatLargeNumberWords(minor_casualties)} people
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="tsunamiHeightChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="arrivalTimeChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="waterCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #0a2540; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">💨 Water Vapor & Atmospheric Effects</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Water Vaporized:</b><br>
                ${(water_vaporized/1e12).toFixed(2)} trillion kg<br>
                <span style="font-size: 0.85em; color: #aaa;">Enough to fill ${(water_vaporized/1e9).toFixed(0)} Olympic pools</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Steam Plume Height:</b><br>
                ${(Math.pow(E_megatons, 0.3) * 30).toFixed(1)} km<br>
                <span style="font-size: 0.85em; color: #aaa;">Reaches stratosphere</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Salt Aerosols:</b><br>
                ${(displaced_mass * 0.035 / 1e12).toFixed(2)} trillion kg<br>
                <span style="font-size: 0.85em; color: #aaa;">Global atmospheric distribution</span>
            </div>
            <div style="background: rgba(30,144,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #1E90FF;">
                <b style="color: #1E90FF;">Climate Impact Duration:</b><br>
                ${(Math.log10(E_megatons) * 6).toFixed(0)} months<br>
                <span style="font-size: 0.85em; color: #aaa;">Increased humidity, rainfall changes</span>
            </div>
        </div>
    </div>

    <div class="info-section" style="background: #001a33; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">⚠️ Secondary Effects</h3>
        <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.8; font-size: 0.9em;">
            <li><b>Seiche Waves:</b> Oscillating waves in enclosed bays and harbors lasting hours to days</li>
            <li><b>Rogue Waves:</b> Individual waves reaching ${(initial_amplitude * 1.5).toFixed(0)}m+ in deep ocean</li>
            <li><b>Underwater Landslides:</b> Continental shelf collapses generating secondary tsunamis</li>
            <li><b>Resonance Effects:</b> Amplified waves in certain coastal geometries and harbors</li>
            <li><b>Multiple Wave Trains:</b> Series of ${Math.floor(Math.sqrt(E_megatons))} major waves over ${(wave_period * Math.sqrt(E_megatons) / 60).toFixed(0)} minutes</li>
            <li><b>Acoustic Shock:</b> Underwater pressure wave kills marine life within ${(transient_crater_diameter/1000).toFixed(0)} km</li>
            <li><b>Ocean Current Disruption:</b> Thermohaline circulation affected for months</li>
        </ul>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #001f3f 0%, #003d7a 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #1E90FF;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">📊 Impact Statistics</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
            <b>Total Coastal Population at Risk:</b> ${formatLargeNumberWords(minor_casualties)} people<br>
            <b>Immediate Inundation Zone:</b> ${formatLargeNumberWords(mega_casualties)} people<br>
            <b>Critical Evacuation Zone:</b> ${formatLargeNumberWords(major_casualties - mega_casualties)} people<br>
            <b>Extended Warning Zone:</b> ${formatLargeNumberWords(moderate_casualties - major_casualties)} people<br><br>
            <b style="color: #FFD700;">Estimated Fatalities:</b> ${formatLargeNumberWords(Math.floor(mega_casualties * 0.8 + major_casualties * 0.3))} people<br>
            <b style="color: #FFD700;">Infrastructure Loss:</b> $${(mega_casualties * 50000 / 1e9).toFixed(0)} trillion USD<br>
            <b style="color: #FFD700;">Ships Destroyed:</b> ${Math.floor(mega_casualties / 10000)} vessels within mega-tsunami zone
        </div>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c23 100%); padding: 15px; border-radius: 8px; margin-top: 15px;">
        <h3 style="margin: 0 0 10px 0; color: white;">🚨 Warning & Evacuation Timeline</h3>
        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-size: 0.9em;">
            <b>Detection to Impact:</b> Varies (hours to years depending on advance warning)<br>
            <b>Tsunami Generation:</b> Instantaneous at impact<br>
            <b>First Wave Arrival (50 km coast):</b> ${getArrivalTime(50000).toFixed(0)} minutes<br>
            <b>First Wave Arrival (500 km coast):</b> ${(getArrivalTime(500000)/60).toFixed(1)} hours<br>
            <b>First Wave Arrival (2000 km coast):</b> ${(getArrivalTime(2000000)/60).toFixed(1)} hours<br>
            <b>Wave Train Duration:</b> ${(wave_period * Math.sqrt(E_megatons) / 3600).toFixed(1)} hours<br>
            <b>All-Clear Time:</b> ${(wave_period * Math.sqrt(E_megatons) / 3600 * 2).toFixed(0)} hours after last major wave
        </div>
    </div>

    <div class="info-section" style="background: #1a0033; padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #1E90FF;">
        <h3 style="margin: 0 0 10px 0; color: #1E90FF;">🛡️ Survival & Protection Measures</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
            <div style="background: rgba(30,144,255,0.15); padding: 10px; border-radius: 5px;">
                <b style="color: #4169E1;">✓ Effective Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Move to high ground (>100m elevation)</li>
                    <li>Move inland (>5 km from coast)</li>
                    <li>Evacuate immediately upon warning</li>
                    <li>Seek upper floors of strong concrete buildings</li>
                    <li>Avoid harbors, rivers, beaches</li>
                </ul>
            </div>
            <div style="background: rgba(255,0,0,0.15); padding: 10px; border-radius: 5px;">
                <b style="color: #FF6347;">✗ Dangerous Actions:</b>
                <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                    <li>Staying near coast to watch</li>
                    <li>Returning after first wave</li>
                    <li>Taking boats to deep water</li>
                    <li>Sheltering in vehicles or wood structures</li>
                    <li>Underestimating wave arrival time</li>
                </ul>
            </div>
        </div>
    </div>
    `;
}

async function initWaterCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const ocean_depth = 4000;
    const g = 9.81;
    const initial_amplitude = Math.pow(E_megatons, 0.5) * 50;
    const tsunami_speed = Math.sqrt(g * ocean_depth);
    
    function getTsunamiHeight(distance_m) {
        const distance_km = distance_m / 1000;
        if (distance_km < 10) return initial_amplitude;
        const amplitude = initial_amplitude * Math.sqrt(10 / distance_km);
        const friction_loss = Math.exp(-distance_km / 1000);
        return amplitude * friction_loss;
    }
    
    function getCoastalWaveHeight(deep_water_height) {
        const amplification_factor = Math.pow(ocean_depth / 10, 0.25);
        return deep_water_height * amplification_factor * 2;
    }
    
    function getArrivalTime(distance_m) {
        return distance_m / tsunami_speed / 60;
    }
    
    const mega_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 50);
    const major_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 200);
    const moderate_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 500);
    const minor_casualties = await fetchPopulation(asteroidData.lat, asteroidData.lon, 1000);
    
    // Chart 1: Tsunami Wave Height vs Distance
    const distances = [];
    const deepWaterHeights = [];
    const coastalHeights = [];
    
    for (let d = 10; d <= 2000; d += 20) {
        distances.push(d);
        const deepHeight = getTsunamiHeight(d * 1000);
        deepWaterHeights.push(deepHeight);
        coastalHeights.push(getCoastalWaveHeight(deepHeight));
    }

    new Chart(document.getElementById('tsunamiHeightChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Deep Water Wave Height (m)',
                data: deepWaterHeights,
                borderColor: '#1E90FF',
                backgroundColor: 'rgba(30,144,255,0.2)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0
            }, {
                label: 'Coastal Wave Height (m)',
                data: coastalHeights,
                borderColor: '#FF6347',
                backgroundColor: 'rgba(255,99,71,0.2)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Tsunami Wave Height vs Distance from Impact',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Wave Height (m, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 2: Tsunami Arrival Time
    const arrivalDistances = [50, 100, 200, 500, 1000, 1500, 2000];
    const arrivalTimes = arrivalDistances.map(d => getArrivalTime(d * 1000));
    
    new Chart(document.getElementById('arrivalTimeChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: arrivalDistances.map(d => d + ' km'),
            datasets: [{
                label: 'Tsunami Arrival Time (minutes)',
                data: arrivalTimes,
                backgroundColor: [
                    'rgba(255,0,0,0.8)',
                    'rgba(255,69,0,0.8)',
                    'rgba(255,140,0,0.8)',
                    'rgba(30,144,255,0.8)',
                    'rgba(65,105,225,0.8)',
                    'rgba(135,206,235,0.8)',
                    'rgba(176,224,230,0.8)'
                ],
                borderColor: '#1E90FF',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Tsunami Arrival Time by Distance',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const minutes = context.parsed.y;
                            const hours = (minutes / 60).toFixed(1);
                            return `${minutes.toFixed(0)} minutes (${hours} hours)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Arrival Time (minutes)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Coastal Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Population Exposure by Zone
    new Chart(document.getElementById('waterCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Mega-Tsunami (0-50km)', 'Major Tsunami (50-200km)', 'Moderate (200-500km)', 'Minor (500-1000km)'],
            datasets: [{
                data: [
                    mega_casualties,
                    major_casualties - mega_casualties,
                    moderate_casualties - major_casualties,
                    minor_casualties - moderate_casualties
                ],
                backgroundColor: [
                    'rgba(0,0,128,0.8)',
                    'rgba(0,0,205,0.8)',
                    'rgba(65,105,225,0.8)',
                    'rgba(135,206,235,0.8)'
                ],
                borderColor: '#001f3f',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 11 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Coastal Population Exposure by Tsunami Zone',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} people (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


function showWindMap() {
    // Bail if no data
    if (!asteroidData) return;

    // Remove previous wind map layer, if any
    if (currentMapLayer) {
        mainMap.removeLayer(currentMapLayer);
        currentMapLayer = null;
    }
    // Atmospheric filtering model
    function willAsteroidReachGround(data) {
        const r_m = data.radius;
        const v = data.velocity * 1000;
        const min_ground_impact_radius = 25;
        const velocity_factor = v / 15000;
        const effective_min_radius = min_ground_impact_radius / Math.sqrt(velocity_factor);
        return r_m > effective_min_radius;
    }

    // Physical constants and asteroid parameters
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4 / 3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;

    // Overpressure at distance (m)
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000; // Extreme pressure close-in
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }

    // Overpressure (bar) to wind speed (m/s)
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }

    // Binary search for radius at given wind speed (m/s)
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m, high = 500000, mid;
        while (high - low > 50) {
            mid = (low + high) / 2;
            const wind_speed = overpressureToWindSpeed(getOverpressure(mid));
            if (wind_speed > target_wind_speed_ms) low = mid;
            else high = mid;
        }
        return (low + high) / 2;
    }

    // Wind speed thresholds (m/s)
    const thresholds = [
        { speed: 3830, color: '#000000', label: '💨 Hypersonic Winds', fillOpacity: 0.9, description: 'Complete molecular disintegration' },
        { speed: 400, color: '#4B0082', label: '🌪️ Faster Than Jupiter Storms', fillOpacity: 0.75, description: 'Total obliteration' },
        { speed: 135, color: '#8B0000', label: '🏚️ Total Building Destruction', fillOpacity: 0.6, description: 'All structures leveled' },
        { speed: 89, color: '#FF4500', label: '🌪️ EF5 Tornado Conditions', fillOpacity: 0.45, description: 'Homes destroyed, vehicles airborne' },
        { speed: 50, color: '#FFA500', label: '🏠 Severe Structural Damage', fillOpacity: 0.3, description: 'Roofs torn, walls collapsed' },
        { speed: 33, color: '#90EE90', label: '🌲 Tree Destruction Zone', fillOpacity: 0.15, description: 'Most trees uprooted' }
    ];

    // Cap radii to avoid giant circles
    const MAX_RADIUS_METERS = 200000; // 200km
    const zones = thresholds.map(th => {
        const r = getDistanceForWindSpeed(th.speed);
        return {
            ...th,
            radius: Math.min(r, MAX_RADIUS_METERS),
            details: `Wind Speed: >${th.speed} m/s<br>Max radius: ${(Math.min(r, MAX_RADIUS_METERS)/1000).toFixed(2)} km`
        };
    });

    // Only keep zones with radius > asteroid and radius > 0
    const validZones = zones.filter(z => z.radius > r_m && z.radius > 0);

    // New layer group
    const windLayer = L.layerGroup();

    // Draw wind zones (largest first)
    validZones.sort((a, b) => b.radius - a.radius).forEach(zone => {
        L.circle([asteroidData.lat, asteroidData.lon], {
            radius: zone.radius,
            color: zone.color,
            fillColor: zone.color,
            fillOpacity: zone.fillOpacity,
            weight: 2
        }).addTo(windLayer).bindPopup(`<b>${zone.label}</b><br>${zone.details}<br>${zone.description}`);
    });

    // Add impact marker
    L.marker([asteroidData.lat, asteroidData.lon], {
        icon: L.divIcon({
            className: 'impact-marker',
            html: '<div style="background: #ff0000; width: 20px; height: 20px; border-radius: 50%; border: 3px solid #000; box-shadow: 0 0 20px rgba(255,0,0,1);"></div>',
            iconSize: [20, 20]
        })
    }).addTo(windLayer).bindPopup(`
        <b>Impact Ground Zero</b><br>
        Peak Wind: ${(overpressureToWindSpeed(getOverpressure(100)) * 2.237).toFixed(0)} mph<br>
        Peak Overpressure: ${getOverpressure(100).toFixed(1)} bar<br>
        Blast Wave Speed: ${(Math.pow(E_megatons, 0.25) * 1000).toFixed(0)} m/s
    `);

    // Add to map and assign for later cleanup
    windLayer.addTo(mainMap);
    currentMapLayer = windLayer;
    // Fit to largest valid radius or skip if none
    if (validZones.length) {
        const maxR = Math.max(...validZones.map(z => z.radius));
        const lat = asteroidData.lat, lon = asteroidData.lon;
        mainMap.fitBounds([
            [lat - maxR/111320, lon - maxR/(111320 * Math.cos(lat * Math.PI / 180))],
            [lat + maxR/111320, lon + maxR/(111320 * Math.cos(lat * Math.PI / 180))]
        ]);
    }
}


async function generateWindContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    // Check if asteroid will reach the ground
    if (!willAsteroidReachGround(asteroidData)) {
        const oldMessage = document.getElementById("windMessage");
        if (oldMessage) oldMessage.remove();
        
        const messageDiv = document.createElement("div");
        messageDiv.id = "windMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#2196F3";
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(0,0,0,0.3)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>💨 Atmospheric Airburst</h2>
            <p>The asteroid will explode in the atmosphere.<br><b>Wind effects still occur but from airburst altitude.</b></p>
            <button id="closeWindMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #2196F3;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        
        document.body.appendChild(messageDiv);
        
        document.getElementById("closeWindMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
    }
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    // Wind speed calculations
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000;
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }
    
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }
    
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m;
        let high = 500000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const overpressure = getOverpressure(mid);
            const wind_speed = overpressureToWindSpeed(overpressure);
            
            if (wind_speed > target_wind_speed_ms) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const hypersonic_radius = getDistanceForWindSpeed(3830);
    const jupiter_radius = getDistanceForWindSpeed(400);
    const total_destruction_radius = getDistanceForWindSpeed(135);
    const ef5_radius = getDistanceForWindSpeed(89);
    const severe_damage_radius = getDistanceForWindSpeed(50);
    const tree_destruction_radius = getDistanceForWindSpeed(33);
    
    // Peak wind speed at impact
    const peak_wind_speed_ms = overpressureToWindSpeed(getOverpressure(100));
    const peak_wind_speed_mph = peak_wind_speed_ms * 2.237;
    const peak_wind_speed_kmh = peak_wind_speed_ms * 3.6;
    
    // Blast wave arrival times
    const blast_wave_speed = Math.pow(E_megatons, 0.25) * 340; // m/s
    
    function getArrivalTime(distance_m) {
        return distance_m / blast_wave_speed;
    }
    
    // Population casualties
    const casualties_hypersonic = await fetchPopulation(asteroidData.lat, asteroidData.lon, hypersonic_radius/1000);
    const casualties_jupiter = await fetchPopulation(asteroidData.lat, asteroidData.lon, jupiter_radius/1000);
    const casualties_total_destruction = await fetchPopulation(asteroidData.lat, asteroidData.lon, total_destruction_radius/1000);
    const casualties_ef5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, ef5_radius/1000);
    const casualties_severe = await fetchPopulation(asteroidData.lat, asteroidData.lon, severe_damage_radius/1000);
    const casualties_trees = await fetchPopulation(asteroidData.lat, asteroidData.lon, tree_destruction_radius/1000);
    
    // Total wind-related deaths (mainly from building collapse and debris)
    const total_wind_deaths = Math.floor(
        casualties_hypersonic * 1.0 + 
        (casualties_jupiter - casualties_hypersonic) * 1.0 +
        (casualties_total_destruction - casualties_jupiter) * 0.95 +
        (casualties_ef5 - casualties_total_destruction) * 0.70 +
        (casualties_severe - casualties_ef5) * 0.30 +
        (casualties_trees - casualties_severe) * 0.05
    );
    
    return `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background-color: #007BFF; padding: 10px; border-radius: 5px;">
        <div>
            <span style="color: white;"><b>Peak Wind Speed:</b></span> ${formatLargeNumberWords(peak_wind_speed_mph)} mph (${formatLargeNumberWords(peak_wind_speed_kmh)} km/h)<br>
            <span style="color: white;"><b>Peak Overpressure:</b></span> ${getOverpressure(100).toFixed(1)} bar (${(getOverpressure(100) * 14.5).toFixed(0)} psi)<br>
            <span style="color: white;"><b>Blast Wave Speed:</b></span> ${(blast_wave_speed).toFixed(0)} m/s (Mach ${(blast_wave_speed/340).toFixed(1)})<br>
            <span style="color: white;"><b>Total Wind Deaths:</b></span> ${formatLargeNumberWords(total_wind_deaths)} people
        </div>
        <div>
            <span style="color: white;"><b>Dynamic Pressure:</b></span> ${((0.5 * 1.225 * Math.pow(peak_wind_speed_ms, 2))/1000).toFixed(0)} kPa<br>
            <span style="color: white;"><b>Blast Duration:</b></span> ${(Math.pow(E_megatons, 0.33) * 2).toFixed(1)} seconds<br>
            <span style="color: white;"><b>Max Debris Velocity:</b></span> ${(peak_wind_speed_mph * 0.6).toFixed(0)} mph<br>
            <span style="color: white;"><b>Affected Area:</b></span> ${formatLargeNumberWords(Math.PI * Math.pow(tree_destruction_radius/1000, 2))} km²
        </div>
    </div>
    

    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">💨 Blast Wave Visualization</h3>
        <div style="position: relative; height: 300px; background: radial-gradient(circle, #000000 0%, #4B0082 10%, #8B0000 25%, #FF4500 45%, #FFA500 65%, #90EE90 85%, #1a1a2e 100%); border-radius: 8px; overflow: hidden;">
            <svg width="100%" height="100%" viewBox="0 0 400 300" style="position: absolute; top: 0; left: 0;">
                <!-- Impact point -->
                <circle cx="200" cy="150" r="6" fill="#ff0000" stroke="white" stroke-width="2"/>
                
                <!-- Expanding blast waves -->
                <circle cx="200" cy="150" r="20" fill="none" stroke="white" stroke-width="3" opacity="0.9"/>
                <circle cx="200" cy="150" r="40" fill="none" stroke="#4B0082" stroke-width="3" opacity="0.8"/>
                <circle cx="200" cy="150" r="60" fill="none" stroke="#8B0000" stroke-width="3" opacity="0.7"/>
                <circle cx="200" cy="150" r="80" fill="none" stroke="#FF4500" stroke-width="2" opacity="0.6"/>
                <circle cx="200" cy="150" r="100" fill="none" stroke="#FFA500" stroke-width="2" opacity="0.5"/>
                <circle cx="200" cy="150" r="130" fill="none" stroke="#90EE90" stroke-width="2" opacity="0.4"/>
                
                <!-- Wind speed arrows -->
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#00d4ff" />
                    </marker>
                </defs>
                
                <!-- Radial wind arrows -->
                <line x1="200" y1="150" x2="260" y2="150" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="170" y2="100" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="140" y2="150" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="200" y1="150" x2="230" y2="200" stroke="#00d4ff" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Labels -->
                <text x="200" y="145" text-anchor="middle" fill="white" font-size="11" font-weight="bold">GROUND</text>
                <text x="200" y="158" text-anchor="middle" fill="white" font-size="11" font-weight="bold">ZERO</text>
                <text x="270" y="155" text-anchor="start" fill="white" font-size="10">${(peak_wind_speed_mph).toFixed(0)} mph</text>
                <text x="175" y="95" text-anchor="middle" fill="white" font-size="9">Hypersonic</text>
                <text x="320" y="155" text-anchor="start" fill="#90EE90" font-size="9">Tree zone</text>
            </svg>
        </div>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa; text-align: center;">
            Blast wave propagation showing wind speed zones radiating from impact (top view)
        </p>
    </div>

    <div class="info-section" style="background: linear-gradient(135deg, #000000 0%, #4B0082 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #00d4ff;">
        <h3 style="margin: 0 0 10px 0; color: white;">🌪️ Wind Damage Zones</h3>
        
        <div style="background: rgba(0,0,0,0.5); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #ffffff;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">💨 Hypersonic Winds (>8,560 mph)</h4>
            <b>Radius:</b> ${(hypersonic_radius/1000).toFixed(2)} km (${(hypersonic_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(hypersonic_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(hypersonic_radius).toFixed(1)} bar<br>
            <b>Effects:</b> Complete molecular disintegration, nothing recognizable remains, ground scoured to bedrock<br>
            <b>Arrival Time:</b> ${getArrivalTime(hypersonic_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_hypersonic)} (100% fatality)
        </div>

        <div style="background: rgba(75,0,130,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #4B0082;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">🌀 Faster Than Jupiter Storms (>900 mph)</h4>
            <b>Radius:</b> ${(jupiter_radius/1000).toFixed(2)} km (${(jupiter_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(jupiter_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(jupiter_radius).toFixed(2)} bar<br>
            <b>Effects:</b> Total obliteration of all structures, reinforced concrete pulverized, vehicles become supersonic projectiles<br>
            <b>Comparison:</b> Exceeds wind speeds in Jupiter's Great Red Spot (400 mph)<br>
            <b>Arrival Time:</b> ${getArrivalTime(jupiter_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_jupiter - casualties_hypersonic)} additional (100% fatality)
        </div>

        <div style="background: rgba(139,0,0,0.4); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #8B0000;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">🏚️ Total Building Destruction (>300 mph)</h4>
            <b>Radius:</b> ${(total_destruction_radius/1000).toFixed(2)} km (${(total_destruction_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(total_destruction_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(total_destruction_radius).toFixed(2)} bar<br>
            <b>Effects:</b> All buildings leveled regardless of construction, steel-reinforced structures collapse, debris field of unrecognizable material<br>
            <b>Arrival Time:</b> ${getArrivalTime(total_destruction_radius).toFixed(1)} seconds<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_total_destruction - casualties_jupiter)} additional (95% fatality)
        </div>

        <div style="background: rgba(255,69,0,0.3); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #FF4500;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">🌪️ EF5 Tornado Conditions (>200 mph)</h4>
            <b>Radius:</b> ${(ef5_radius/1000).toFixed(2)} km (${(ef5_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(ef5_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(ef5_radius).toFixed(2)} bar<br>
            <b>Effects:</b> Well-built homes destroyed, cars and trucks thrown hundreds of meters, people become lethal projectiles<br>
            <b>Comparison:</b> Equivalent to the most violent tornadoes ever recorded<br>
            <b>Arrival Time:</b> ${(getArrivalTime(ef5_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_ef5 - casualties_total_destruction)} additional (70% fatality)
        </div>

        <div style="background: rgba(255,165,0,0.2); padding: 12px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #FFA500;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">🏠 Severe Structural Damage (>112 mph)</h4>
            <b>Radius:</b> ${(severe_damage_radius/1000).toFixed(2)} km (${(severe_damage_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(severe_damage_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(severe_damage_radius).toFixed(3)} bar<br>
            <b>Effects:</b> Roofs torn off, exterior walls collapsed, windows shattered, mobile homes destroyed, flying debris causes mass casualties<br>
            <b>Arrival Time:</b> ${(getArrivalTime(severe_damage_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_severe - casualties_ef5)} additional (30% fatality)
        </div>

        <div style="background: rgba(144,238,144,0.15); padding: 12px; border-radius: 6px; border-left: 3px solid #90EE90;">
            <h4 style="margin: 0 0 8px 0; color: #fff;">🌲 Tree Destruction Zone (>75 mph)</h4>
            <b>Radius:</b> ${(tree_destruction_radius/1000).toFixed(2)} km (${(tree_destruction_radius/1609).toFixed(1)} miles)<br>
            <b>Wind Speed:</b> ${(overpressureToWindSpeed(getOverpressure(tree_destruction_radius)) * 2.237).toFixed(0)} mph<br>
            <b>Overpressure:</b> ${getOverpressure(tree_destruction_radius).toFixed(3)} bar<br>
            <b>Effects:</b> Nearly all trees uprooted or snapped, power lines down, significant roof damage, broken windows, outdoor structures destroyed<br>
            <b>Arrival Time:</b> ${(getArrivalTime(tree_destruction_radius)/60).toFixed(1)} minutes<br>
            <b>Casualties:</b> ${formatLargeNumberWords(casualties_trees - casualties_severe)} additional (5% fatality)
        </div>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windZonesChart" height="200"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windSpeedDistanceChart" height="220"></canvas>
    </div>

    <div class="chart-container" style="margin-bottom: 15px;">
        <canvas id="windCasualtiesChart" height="200"></canvas>
    </div>

    <div class="info-section" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">⏱️ Blast Wave Timeline</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+0.0s:</b><br>Impact<br>
                    <span style="font-size: 0.85em; color: #aaa;">Ground zero detonation</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${getArrivalTime(hypersonic_radius).toFixed(1)}s:</b><br>Hypersonic zone<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(hypersonic_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${getArrivalTime(jupiter_radius).toFixed(1)}s:</b><br>Jupiter winds<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(jupiter_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(total_destruction_radius)/60).toFixed(1)}min:</b><br>Total destruction<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(total_destruction_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(ef5_radius)/60).toFixed(1)}min:</b><br>EF5 tornado<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(ef5_radius/1609).toFixed(1)} miles</span>
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #00d4ff;">
                    <b style="color: #00d4ff;">T+${(getArrivalTime(tree_destruction_radius)/60).toFixed(1)}min:</b><br>Tree destruction<br>
                    <span style="font-size: 0.85em; color: #aaa;">${(tree_destruction_radius/1609).toFixed(1)} miles</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #ff6600;">💥 Debris and Projectiles</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Maximum Debris Velocity:</b><br>
                    ${(peak_wind_speed_mph * 0.6).toFixed(0)} mph<br>
                    <span style="font-size: 0.85em; color: #aaa;">Large objects become supersonic missiles</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Lethal Debris Range:</b><br>
                    ${(ef5_radius/1000 * 1.5).toFixed(1)} km<br>
                    <span style="font-size: 0.85em; color: #aaa;">Cars, trucks, building materials airborne</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Human Body Displacement:</b><br>
                    Up to ${(peak_wind_speed_mph * 0.3).toFixed(0)} meters<br>
                    <span style="font-size: 0.85em; color: #aaa;">People thrown like ragdolls in close zones</span>
                </div>
                <div style="background: rgba(255,102,0,0.1); padding: 10px; border-radius: 5px; border-left: 3px solid #ff6600;">
                    <b style="color: #ff6600;">Glass Fragment Velocity:</b><br>
                    ${(peak_wind_speed_mph * 0.8).toFixed(0)} mph<br>
                    <span style="font-size: 0.85em; color: #aaa;">Billions of glass shards become shrapnel</span>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">🏗️ Structural Damage Assessment</h3>
            <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(0,212,255,0.2); border-bottom: 2px solid #00d4ff;">
                        <th style="padding: 8px; text-align: left;">Structure Type</th>
                        <th style="padding: 8px; text-align: center;">Damage Radius</th>
                        <th style="padding: 8px; text-align: center;">Wind Speed</th>
                        <th style="padding: 8px; text-align: left;">Damage Level</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Reinforced Concrete Bunkers</td>
                        <td style="padding: 8px; text-align: center;">${(jupiter_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">900+ mph</td>
                        <td style="padding: 8px;">Complete destruction</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Steel-Frame Skyscrapers</td>
                        <td style="padding: 8px; text-align: center;">${(total_destruction_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">300+ mph</td>
                        <td style="padding: 8px;">Total collapse</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Brick/Concrete Homes</td>
                        <td style="padding: 8px; text-align: center;">${(ef5_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">200+ mph</td>
                        <td style="padding: 8px;">Walls collapsed, rubble</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Wood-Frame Houses</td>
                        <td style="padding: 8px; text-align: center;">${(severe_damage_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">112+ mph</td>
                        <td style="padding: 8px;">Destroyed beyond repair</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #444;">
                        <td style="padding: 8px;">Mobile Homes</td>
                        <td style="padding: 8px; text-align: center;">${(tree_destruction_radius/1609 * 0.8).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">75+ mph</td>
                        <td style="padding: 8px;">Disintegrated, scattered</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px;">Vehicles (Cars/Trucks)</td>
                        <td style="padding: 8px; text-align: center;">${(ef5_radius/1609).toFixed(1)} mi</td>
                        <td style="padding: 8px; text-align: center;">200+ mph</td>
                        <td style="padding: 8px;">Airborne, crushed</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 10px 0; color: white;">🚑 Total Wind-Related Casualties</h3>
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">
                    ${formatLargeNumberWords(total_wind_deaths)} Deaths
                </div>
                <div style="font-size: 0.95em; line-height: 1.7;">
                    <b>Primary Causes of Death:</b>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li>Building collapse and crushing (45%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.45))} people</li>
                        <li>Flying debris impact (30%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.30))} people</li>
                        <li>Impact with stationary objects (15%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.15))} people</li>
                        <li>Asphyxiation from debris burial (7%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.07))} people</li>
                        <li>Other trauma (3%): ${formatLargeNumberWords(Math.floor(total_wind_deaths * 0.03))} people</li>
                    </ul>
                    <b>Injured (non-fatal):</b> ${formatLargeNumberWords(Math.floor(total_wind_deaths * 2.5))} additional casualties requiring medical attention
                </div>
            </div>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">💡 Blast Wave Facts</h3>
            <ul style="margin: 5px 0; padding-left: 20px; line-height: 1.7; font-size: 0.9em;">
                <li>The blast wave is a supersonic shock front traveling faster than the speed of sound</li>
                <li>There are two phases: positive phase (pushing) and negative phase (suction) - both are deadly</li>
                <li>The negative phase can be 2-3 times longer than the positive phase, pulling debris back</li>
                <li>Wind speeds peak instantly - there is no "ramp up" period for preparation</li>
                <li>The blast wave reflects off surfaces, creating complex interference patterns that can amplify or reduce effects</li>
                <li>Valleys and urban canyons can channel winds, increasing destruction in specific corridors</li>
                <li>Being underground provides almost complete protection from blast effects</li>
                <li>The blast wave continues long after visible fireball dissipates</li>
                <li>Overpressure alone (without wind) can cause lethal injuries to lungs and internal organs</li>
                <li>Animals with air-filled cavities (lungs, intestines) are extremely vulnerable to overpressure</li>
            </ul>
        </div>

        <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); padding: 15px; border-radius: 8px; margin-top: 15px; border: 2px solid #27ae60;">
            <h3 style="margin: 0 0 10px 0; color: white;">🛡️ Survival Strategies</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9em;">
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">✓ Best Protection:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Underground shelters/basements</li>
                        <li>Center of concrete buildings</li>
                        <li>Below ground level</li>
                        <li>Away from windows and doors</li>
                        <li>Behind thick walls or earth</li>
                    </ul>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">⚠️ Critical Actions:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Get below ground immediately</li>
                        <li>Lie flat, face down</li>
                        <li>Cover head and neck</li>
                        <li>Stay clear of windows</li>
                        <li>Wait for both blast phases</li>
                    </ul>
                </div>
                <div style="background: rgba(192,57,43,0.3); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">✗ Death Traps:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Vehicles (become projectiles)</li>
                        <li>Above-ground structures</li>
                        <li>Near windows or glass</li>
                        <li>Open areas</li>
                        <li>Upper floors of buildings</li>
                    </ul>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px;">
                    <b style="color: white;">⏰ Warning Time:</b>
                    <ul style="margin: 5px 0; padding-left: 15px; line-height: 1.5;">
                        <li>Light flash: instant</li>
                        <li>Thermal pulse: 0-1 second</li>
                        <li>Blast wave: ${(getArrivalTime(severe_damage_radius)/60).toFixed(0)}-${(getArrivalTime(tree_destruction_radius)/60).toFixed(0)} minutes at outer zones</li>
                        <li>No warning at close range</li>
                        <li>Seconds to take cover</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="info-section" style="background: #34495e; padding: 15px; border-radius: 8px; margin-top: 15px;">
            <h3 style="margin: 0 0 10px 0; color: #00d4ff;">📊 Comparative Wind Speeds</h3>
            <div style="font-size: 0.9em; line-height: 1.8;">
                <b>Impact Peak Wind:</b> ${formatLargeNumberWords(peak_wind_speed_mph)} mph<br>
                <b>Jupiter's Great Red Spot:</b> 400 mph (${((peak_wind_speed_mph/400).toFixed(1))}x weaker)<br>
                <b>Neptune's Fastest Winds:</b> 1,200 mph (${((peak_wind_speed_mph/1200).toFixed(1))}x weaker)<br>
                <b>Strongest Tornado (EF5):</b> 200-300 mph (${((peak_wind_speed_mph/250).toFixed(1))}x weaker)<br>
                <b>Category 5 Hurricane:</b> 157+ mph (${((peak_wind_speed_mph/157).toFixed(1))}x weaker)<br>
                <b>Speed of Sound:</b> 767 mph (Mach ${(peak_wind_speed_mph/767).toFixed(1)})<br>
                <b>Commercial Jet Cruise:</b> 550 mph (${((peak_wind_speed_mph/550).toFixed(1))}x faster)
            </div>
        </div>
    `;
}

async function initWindCharts() {
    if (!asteroidData) return;
    
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    function getOverpressure(distance_m) {
        const distance_km = distance_m / 1000;
        const scaled_distance = distance_km / Math.pow(E_megatons, 1/3);
        if (scaled_distance < 0.1) return 1000;
        return 6.7 / Math.pow(scaled_distance, 3) + 1 / Math.pow(scaled_distance, 2);
    }
    
    function overpressureToWindSpeed(overpressure_bar) {
        const overpressure_pa = overpressure_bar * 100000;
        return Math.sqrt((2 * overpressure_pa) / 1.225);
    }
    
    function getDistanceForWindSpeed(target_wind_speed_ms) {
        let low = r_m;
        let high = 500000;
        
        while (high - low > 100) {
            const mid = (low + high) / 2;
            const overpressure = getOverpressure(mid);
            const wind_speed = overpressureToWindSpeed(overpressure);
            
            if (wind_speed > target_wind_speed_ms) {
                low = mid;
            } else {
                high = mid;
            }
        }
        
        return (low + high) / 2;
    }
    
    const hypersonic_radius = getDistanceForWindSpeed(3830);
    const jupiter_radius = getDistanceForWindSpeed(400);
    const total_destruction_radius = getDistanceForWindSpeed(135);
    const ef5_radius = getDistanceForWindSpeed(89);
    const severe_damage_radius = getDistanceForWindSpeed(50);
    const tree_destruction_radius = getDistanceForWindSpeed(33);
    
    const casualties_hypersonic = await fetchPopulation(asteroidData.lat, asteroidData.lon, hypersonic_radius/1000);
    const casualties_jupiter = await fetchPopulation(asteroidData.lat, asteroidData.lon, jupiter_radius/1000);
    const casualties_total_destruction = await fetchPopulation(asteroidData.lat, asteroidData.lon, total_destruction_radius/1000);
    const casualties_ef5 = await fetchPopulation(asteroidData.lat, asteroidData.lon, ef5_radius/1000);
    const casualties_severe = await fetchPopulation(asteroidData.lat, asteroidData.lon, severe_damage_radius/1000);
    const casualties_trees = await fetchPopulation(asteroidData.lat, asteroidData.lon, tree_destruction_radius/1000);
    
    // Chart 1: Wind Zone Radii
    new Chart(document.getElementById('windZonesChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Hypersonic\n(8,560+ mph)', 'Jupiter Storms\n(900+ mph)', 'Total Destruction\n(300+ mph)', 'EF5 Tornado\n(200+ mph)', 'Severe Damage\n(112+ mph)', 'Tree Destruction\n(75+ mph)'],
            datasets: [{
                label: 'Zone Radius (km)',
                data: [
                    hypersonic_radius / 1000,
                    jupiter_radius / 1000,
                    total_destruction_radius / 1000,
                    ef5_radius / 1000,
                    severe_damage_radius / 1000,
                    tree_destruction_radius / 1000
                ],
                backgroundColor: ['#000000', '#4B0082', '#8B0000', '#FF4500', '#FFA500', '#90EE90'],
                borderColor: '#00d4ff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Wind Damage Zones by Radius',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Radius (km, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        font: { size: 9 }
                    },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Wind Speed vs Distance
    const distances = [];
    const windSpeeds = [];
    const overpressures = [];
    
    for (let d = hypersonic_radius; d <= tree_destruction_radius * 1.2; d += (tree_destruction_radius * 1.2 - hypersonic_radius) / 100) {
        distances.push((d / 1000).toFixed(2));
        const overpressure = getOverpressure(d);
        const windSpeed = overpressureToWindSpeed(overpressure) * 2.237; // Convert to mph
        windSpeeds.push(windSpeed);
        overpressures.push(overpressure);
    }
    
    new Chart(document.getElementById('windSpeedDistanceChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: distances.map(d => d + ' km'),
            datasets: [{
                label: 'Wind Speed (mph)',
                data: windSpeeds,
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.2)',
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 3,
                yAxisID: 'y'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Wind Speed vs Distance from Impact',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Wind Speed (mph, log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { 
                        color: 'white',
                        maxTicksLimit: 15
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Distance from Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Chart 3: Casualties by Wind Zone
    const casualtyData = [
        casualties_hypersonic,
        casualties_jupiter - casualties_hypersonic,
        casualties_total_destruction - casualties_jupiter,
        casualties_ef5 - casualties_total_destruction,
        casualties_severe - casualties_ef5,
        casualties_trees - casualties_severe
    ];
    
    new Chart(document.getElementById('windCasualtiesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: [
                'Hypersonic (100% fatal)',
                'Jupiter Winds (100% fatal)',
                'Total Destruction (95% fatal)',
                'EF5 Tornado (70% fatal)',
                'Severe Damage (30% fatal)',
                'Tree Destruction (5% fatal)'
            ],
            datasets: [{
                data: casualtyData,
                backgroundColor: ['#000000', '#4B0082', '#8B0000', '#FF4500', '#FFA500', '#90EE90'],
                borderColor: '#1a1a2e',
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { 
                        color: 'white',
                        font: { size: 10 }
                    },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Population Affected by Wind Zone',
                    color: 'white',
                    font: { size: 14 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

window.showInfoModal = function(text) {
    // Remove any existing modal
    const old = document.getElementById('info-modal');
    if (old) old.remove();
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'info-modal';
    modal.style.position = 'fixed';
    modal.style.top = '40%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.background = '#333';
    modal.style.color = '#fff';
    modal.style.padding = '24px';
    modal.style.borderRadius = '8px';
    modal.style.zIndex = 99999;
    modal.style.boxShadow = '0 0 20px #0008';
    modal.innerHTML = `
        <div style="font-size:1.1em; margin-bottom:12px;">${text}</div>
        <button onclick="document.getElementById('info-modal').remove()" style="padding:8px 18px; border:none; background:#00d4ff; color:#fff; border-radius:5px; cursor:pointer;">Close</button>
    `;
    document.body.appendChild(modal);
};

// Helper to create an info button with a modal popup
window.window.createInfoButton = function(title, content) {
    const safeContent = String(content).replace(/'/g, "\\'");
    return `<span class="info-btn" style="
        display: inline-block;
        width: 18px;
        height: 18px;
        background: #3498db;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        margin-left: 5px;
        vertical-align: middle;"
        onclick="window.showInfoModal('${safeContent}')"
        title="${title}">i</span>`;
};



async function generateGlobalEffectsContent() {
    if (!asteroidData) return "<p>Loading data...</p>";
    
    if (!willAsteroidReachGround(asteroidData)) {
        const oldMessage = document.getElementById("craterMessage");
        if (oldMessage) oldMessage.remove();
    
        const messageDiv = document.createElement("div");
        messageDiv.id = "craterMessage";
        messageDiv.style.position = "fixed";
        messageDiv.style.top = "50%";
        messageDiv.style.left = "50%";
        messageDiv.style.transform = "translate(-50%, -50%)";
        messageDiv.style.backgroundColor = "#ff5252";
        messageDiv.style.color = "white";
        messageDiv.style.padding = "30px 40px";
        messageDiv.style.borderRadius = "12px";
        messageDiv.style.boxShadow = "0 4px 15px rgba(101, 67, 33, 0.4)";
        messageDiv.style.textAlign = "center";
        messageDiv.style.zIndex = "9999";
        messageDiv.innerHTML = `
            <h2>💨 Asteroid Breakup</h2>
            <p>The asteroid will disintegrate in the atmosphere.</p>
            <button id="closeCraterMessage" style="
                margin-top: 15px;
                padding: 8px 15px;
                background: white;
                color: #ff5252;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
            ">Close</button>
        `;
        document.body.appendChild(messageDiv);
    
        document.getElementById("closeCraterMessage").addEventListener("click", () => {
            messageDiv.remove();
        });
    
        return;
    }

    // ========== PHYSICAL CONSTANTS ==========
    const EARTH_MASS = 5.972e24; // kg
    const EARTH_RADIUS = 6.371e6; // m
    const EARTH_ORBITAL_VELOCITY = 29780; // m/s around Sun
    const EARTH_ANGULAR_MOMENTUM = 7.08e33; // kg·m²/s (rotational)
    const EARTH_VOLUME = (4/3) * Math.PI * Math.pow(EARTH_RADIUS, 3); // m³
    const EARTH_SURFACE_AREA = 4 * Math.PI * Math.pow(EARTH_RADIUS, 2); // m²
    const EARTH_DAY_LENGTH = 86400; // seconds (24 hours)
    
    // ========== ASTEROID PARAMETERS ==========
    const r_m = asteroidData.radius; // meters
    const rho = asteroidData.density; // kg/m³
    const v_kms = asteroidData.velocity; // km/s
    const v = v_kms * 1000; // m/s
    const angle = asteroidData.angle; // degrees
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho; // kg
    
    // Kinetic energy
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15; // 1 megaton TNT = 4.184e15 J
    
    // ========== ORBITAL EFFECTS ==========
    // Source: Korycansky et al. (2001) "Earth's orbit modification by asteroids"
    const impactor_momentum = m * v;
    const earth_orbital_momentum = EARTH_MASS * EARTH_ORBITAL_VELOCITY;
    const momentum_ratio = impactor_momentum / earth_orbital_momentum;
    
    // Orbital velocity change (Delta-v)
    const delta_v_orbital = (m * v * Math.cos(angle * Math.PI / 180)) / EARTH_MASS; // m/s
    
    // Orbital distance change using vis-viva equation approximation
    const semi_major_axis = 1.496e11; // m (1 AU)
    const delta_a = -2 * semi_major_axis * (delta_v_orbital / EARTH_ORBITAL_VELOCITY); // m
    
    let orbital_effect, orbital_description, orbital_color;
    if (Math.abs(momentum_ratio) < 1e-9) {
        orbital_effect = "No Detectable Change";
        orbital_description = "Earth's orbit remains completely unchanged";
        orbital_color = "#27ae60";
    } else if (Math.abs(momentum_ratio) < 1e-6) {
        orbital_effect = "Negligible Change";
        orbital_description = "Orbital perturbation below measurement threshold";
        orbital_color = "#2ecc71";
    } else if (Math.abs(momentum_ratio) < 1e-3) {
        orbital_effect = "Measurable Change";
        orbital_description = "Tiny orbital shift - detectable by precise astronomy only";
        orbital_color = "#f39c12";
    } else if (Math.abs(momentum_ratio) < 0.01) {
        orbital_effect = "Significant Change";
        orbital_description = "Noticeable orbital modification - climate zones shift over millennia";
        orbital_color = "#e67e22";
    } else if (Math.abs(momentum_ratio) < 0.1) {
        orbital_effect = "Major Orbital Disruption";
        orbital_description = "Earth's orbit substantially altered - catastrophic climate change";
        orbital_color = "#d35400";
    } else {
        orbital_effect = "Orbital Catastrophe";
        orbital_description = "Earth ejected from habitable zone or into Sun";
        orbital_color = "#c0392b";
    }
    
    // ========== ROTATIONAL EFFECTS ==========
    // Source: Harris & D'Abramo (2015) "The population of near-Earth asteroids"
    // Assuming perpendicular equatorial impact for maximum effect
    const impact_arm = EARTH_RADIUS; // lever arm (m)
    const tangential_velocity = v * Math.sin(angle * Math.PI / 180);
    const impact_angular_momentum = m * tangential_velocity * impact_arm;
    const angular_momentum_ratio = impact_angular_momentum / EARTH_ANGULAR_MOMENTUM;
    
    // Change in rotation period
    const delta_omega = angular_momentum_ratio * (2 * Math.PI / EARTH_DAY_LENGTH); // rad/s
    const new_day_length = 2 * Math.PI / ((2 * Math.PI / EARTH_DAY_LENGTH) + delta_omega); // seconds
    const day_change = (new_day_length - EARTH_DAY_LENGTH) / 3600; // hours
    
    let rotation_effect, rotation_description, rotation_color;
    if (Math.abs(angular_momentum_ratio) < 1e-6) {
        rotation_effect = "No Change";
        rotation_description = "Earth's 24-hour day remains unchanged";
        rotation_color = "#27ae60";
    } else if (Math.abs(angular_momentum_ratio) < 1e-3) {
        rotation_effect = "Minimal Change";
        rotation_description = `Day length altered by ${Math.abs(day_change * 60).toFixed(1)} minutes`;
        rotation_color = "#f39c12";
    } else if (Math.abs(angular_momentum_ratio) < 0.1) {
        rotation_effect = "Substantial Change";
        rotation_description = `Day length changed by ${Math.abs(day_change).toFixed(1)} hours - seasons disrupted`;
        rotation_color = "#e67e22";
    } else if (Math.abs(angular_momentum_ratio) < 1.0) {
        rotation_effect = "Catastrophic Change";
        rotation_description = "Earth's rotation fundamentally altered - climate chaos";
        rotation_color = "#d35400";
    } else {
        rotation_effect = "Rotation Destroyed";
        rotation_description = "Earth's spin halted or reversed - one side perpetually faces Sun";
        rotation_color = "#c0392b";
    }
    
    // ========== CRATER AND STRUCTURAL EFFECTS ==========
    // Source: Collins et al. (2005) "Earth Impact Effects Program"
    // Transient crater diameter (before collapse)
    const g = 9.81; // m/s²
    const target_density = 2500; // kg/m³ (average crustal rock)
    
    // Scaling law from Holsapple (1993)
    const L = r_m * 2; // projectile diameter
    const impact_velocity = v;
    
    // Transient crater diameter (meters)
    const D_tr = 1.161 * Math.pow(L, 0.78) * Math.pow(impact_velocity/1000, 0.44) * 
                 Math.pow(rho/target_density, 0.36) * Math.pow(target_density/1000, -0.22) * 1000;
    
    // Final crater diameter (after slumping) - typically 1.3-1.5x transient
    const D_final = D_tr * 1.3;
    
    // Crater depth (simple craters: depth/diameter ~ 1/5, complex craters shallower)
    const crater_depth = D_final > 4000 ? D_final / 10 : D_final / 5; // meters
    
    // Crater volume (approximate as cone)
    const crater_volume = (1/3) * Math.PI * Math.pow(D_final/2, 2) * crater_depth; // m³
    const volume_ratio = crater_volume / EARTH_VOLUME;
    
    let disruption_effect, disruption_description, disruption_color;
    if (volume_ratio > 0.01) {
        disruption_effect = "Planetary Destruction";
        disruption_description = "Earth shattered into fragments - becomes asteroid field";
        disruption_color = "#8b0000";
    } else if (volume_ratio > 0.001) {
        disruption_effect = "Extreme Damage";
        disruption_description = "Mantle exposed, global tectonic reset, massive mass loss";
        disruption_color = "#c0392b";
    } else if (volume_ratio > 1e-6) {
        disruption_effect = "Severe Cratering";
        disruption_description = "Mega-crater visible from space, regional crust destroyed";
        disruption_color = "#e67e22";
    } else {
        disruption_effect = "Localized Impact";
        disruption_description = "Crater forms but Earth's structure intact";
        disruption_color = "#27ae60";
    }
    
    // ========== ATMOSPHERIC EFFECTS ==========
    // Source: Toon et al. (1997) "Environmental perturbations caused by impacts"
    
    // Ejecta mass (empirical from nuclear cratering studies)
    const ejecta_mass = crater_volume * target_density * 1.5; // kg (includes fragmented material)
    
    // Dust lofted into atmosphere (typically 1-10% of ejecta)
    const dust_fraction = E_megatons > 1e6 ? 0.1 : 0.05;
    const dust_mass = ejecta_mass * dust_fraction; // kg
    
    // Optical depth (Toon et al. 1997)
    const particle_size = 1e-6; // m (1 micron - optimal for light blocking)
    const extinction_coefficient = 7500; // m²/kg for 1 micron particles
    const column_density = dust_mass / EARTH_SURFACE_AREA; // kg/m²
    const optical_depth = Math.min(column_density * extinction_coefficient, 1000);
    
    // Darkness duration (e-folding time ~ months to years)
    const settling_time = 180; // days for 1 optical depth to settle
    const darkness_duration = optical_depth * settling_time; // days
    
    // Temperature drop (Covey et al. 1994)
    const max_cooling = 25; // °C maximum for global dust cloud
    const temp_drop = Math.min(optical_depth * 5, max_cooling); // °C
    const cooling_duration_years = Math.sqrt(E_megatons / 1000); // years
    
    // ========== CHEMICAL EFFECTS ==========
    // Source: Pope et al. (1997) "Impact winter and the Cretaceous/Tertiary extinctions"
    
    // Sulfur release (depends on target rock - assuming 10% sulfur-bearing minerals)
    const sulfur_fraction = 0.1;
    const vaporized_rock = E_joules / 5e6; // kg (5 MJ/kg vaporization energy)
    const SO2_mass = vaporized_rock * sulfur_fraction * (64/32); // kg (S to SO2 conversion)
    
    // Acid rain pH (simplified model)
    const ocean_volume = 1.335e18; // m³
    const SO2_dissolved_fraction = 0.3;
    const H2SO4_concentration = (SO2_mass * SO2_dissolved_fraction * (98/64)) / ocean_volume; // kg/m³
    const pH_drop = Math.min(Math.log10(H2SO4_concentration * 10), 3);
    const acid_rain_pH = Math.max(5.6 - pH_drop, 1); // normal rain pH is 5.6
    
    // Nitrogen oxides from shock heating
    const NOx_mass = E_joules / 1e10; // kg (rough approximation)
    
    // Ozone depletion (NOx catalytic destruction)
    const ozone_depletion_percent = Math.min((NOx_mass / 1e13) * 50, 95);
    const ozone_recovery_time = ozone_depletion_percent * 2; // years
    
    // ========== THERMAL EFFECTS ==========
    // Source: Melosh et al. (1990) "Ignition of global wildfires"
    
    // Fireball radius (Glasstone & Dolan 1977)
    const fireball_radius = 440 * Math.pow(E_megatons, 0.4); // meters
    
    // Thermal radiation (35% of total energy)
    const thermal_energy = E_joules * 0.35; // joules
    
    // Critical thermal flux for ignition: 20 J/cm² (dry grass/leaves)
    const ignition_flux = 20 * 1e4; // J/m²
    const thermal_radius = Math.sqrt(thermal_energy / (4 * Math.PI * ignition_flux)); // meters
    const wildfire_area = Math.PI * Math.pow(thermal_radius, 2); // m²
    const wildfire_percent = Math.min((wildfire_area / EARTH_SURFACE_AREA) * 100, 100);
    
    // Soot injection into stratosphere
    const forest_coverage = 0.31; // 31% of land is forested
    const land_area = EARTH_SURFACE_AREA * 0.29; // 29% of Earth is land
    const burned_forest_area = wildfire_area * forest_coverage;
    const soot_per_area = 15; // kg/m² (typical for forest fires)
    const soot_mass = burned_forest_area * soot_per_area; // kg
    
    // ========== MASS EXTINCTION ==========
    // Source: Raup & Sepkoski (1982) "Mass extinctions in the marine fossil record"
    
    let extinction_probability, extinction_level;
    if (E_megatons < 10) {
        extinction_probability = 0;
        extinction_level = "No extinctions";
    } else if (E_megatons < 1000) {
        extinction_probability = 5;
        extinction_level = "Local species loss";
    } else if (E_megatons < 1e4) {
        extinction_probability = 20;
        extinction_level = "Regional extinctions";
    } else if (E_megatons < 1e6) {
        extinction_probability = 50;
        extinction_level = "Major mass extinction (>30% species)";
    } else if (E_megatons < 1e8) {
        extinction_probability = 75;
        extinction_level = "Severe mass extinction (>60% species)";
    } else {
        extinction_probability = 95;
        extinction_level = "Near-total extinction (>90% species)";
    }
    
    // Chicxulub comparison (66 Mya, killed dinosaurs)
    const chicxulub_energy = 1e8; // MT
    const chicxulub_ratio = E_megatons / chicxulub_energy;
    
    // ========== HTML OUTPUT ==========
    return `
    <style>
        .info-btn:hover {
            background: #2980b9 !important;
            transform: scale(1.1);
        }
    </style>

    <div style="background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 3px solid #6c5ce7;">
        <h2 style="margin: 0 0 15px 0; color: #00d4ff; text-align: center; font-size: 1.8em;">🌍 GLOBAL PLANETARY EFFECTS</h2>
        <p style="text-align: center; color: #aaa; font-size: 0.95em; margin: 0;">
            Calculations based on peer-reviewed impact physics (Collins 2005, Toon 1997, Melosh 1990)
        </p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div style="background: ${orbital_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">
                🌐 Orbital Change
                ${window.createInfoButton('Orbital Info', 'Based on conservation of linear momentum. Source: Korycansky et al. 2001')}
            </h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${orbital_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Momentum ratio: ${momentum_ratio.toExponential(2)}
            </div>
        </div>
        
        <div style="background: ${rotation_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">
                🔄 Rotation Change
                ${window.createInfoButton('Rotation Info', 'Based on conservation of angular momentum. Maximum effect assumed for perpendicular impact.')}
            </h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${rotation_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Angular momentum ratio: ${angular_momentum_ratio.toExponential(2)}
            </div>
        </div>
        
        <div style="background: ${disruption_color}; padding: 15px; border-radius: 8px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: white;">
                💥 Structural Integrity
                ${window.createInfoButton('Crater Info', 'Transient crater size from Holsapple (1993) scaling laws. Final crater is ~1.3x larger after slumping.')}
            </h3>
            <div style="font-size: 1.3em; font-weight: bold; color: white; margin-bottom: 8px;">
                ${disruption_effect}
            </div>
            <div style="font-size: 0.85em; color: rgba(255,255,255,0.9);">
                Volume ratio: ${volume_ratio.toExponential(2)}
            </div>
        </div>
    </div>

    <!-- ORBITAL DETAILS -->
    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #6c5ce7;">
            🌍 Earth's Orbital Dynamics
            ${window.createInfoButton('Source', 'Korycansky, Laughlin & Adams (2001): Deflection and fragmentation of near-Earth asteroids')}
        </h3>
        <div style="background: rgba(108,92,231,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${orbital_color};">
            <b style="color: ${orbital_color};">${orbital_effect}:</b> ${orbital_description}<br><br>
            <b>Impactor Momentum:</b> ${formatLargeNumberWords(impactor_momentum)} kg·m/s<br>
            <b>Earth Orbital Momentum:</b> ${formatLargeNumberWords(earth_orbital_momentum)} kg·m/s<br>
            <b>Velocity Change (Δv):</b> ${delta_v_orbital.toExponential(2)} m/s<br>
            <b>Orbital Distance Change:</b> ${formatMetric(delta_a)} m (${(Math.abs(delta_a)/1000).toFixed(0)} km)<br><br>
            ${Math.abs(momentum_ratio) >= 1e-6 ? `
                <b style="color: #e74c3c;">⚠️ Orbital Consequences:</b><br>
                • Semi-major axis shift: ${(delta_a/1000).toFixed(0)} km<br>
                • Year length change: ~${(delta_a / semi_major_axis * 365.25).toFixed(3)} days<br>
                • Average temperature change: ~${(delta_a / semi_major_axis * 30).toFixed(2)}°C<br>
                • Climate zone migration: ${Math.abs(delta_a/1000).toFixed(0)} km poleward/equatorward
            ` : `
                <b style="color: #27ae60;">✓ Orbit Stable:</b><br>
                Earth maintains its 149.6 million km orbit. Seasons and climate unchanged.
            `}
        </div>
    </div>

    <!-- ROTATION DETAILS -->
    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #e67e22;">
            🔄 Earth's Rotation & Day Length
            ${window.createInfoButton('Source', 'Harris & D\'Abramo (2015): The population of near-Earth asteroids. Assumes maximum angular momentum transfer.')}
        </h3>
        <div style="background: rgba(230,126,34,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${rotation_color};">
            <b style="color: ${rotation_color};">${rotation_effect}:</b> ${rotation_description}<br><br>
            <b>Impact Angular Momentum:</b> ${formatLargeNumberWords(impact_angular_momentum)} kg·m²/s<br>
            <b>Earth's Rotational Angular Momentum:</b> ${formatLargeNumberWords(EARTH_ANGULAR_MOMENTUM)} kg·m²/s<br>
            <b>Day Length Change:</b> ${Math.abs(day_change * 60).toFixed(2)} minutes (${Math.abs(day_change).toFixed(4)} hours)<br>
            <b>New Day Length:</b> ${(new_day_length / 3600).toFixed(4)} hours<br><br>
            ${Math.abs(angular_momentum_ratio) >= 1e-3 ? `
                <b style="color: #e74c3c;">⚠️ Rotational Consequences:</b><br>
                • Coriolis effect modified - weather patterns change<br>
                • Tidal patterns disrupted<br>
                • Circadian rhythms of life desynchronized<br>
                • Seasons ${Math.abs(angular_momentum_ratio) > 0.01 ? 'fundamentally altered' : 'slightly modified'}
            ` : `
                <b style="color: #27ae60;">✓ Rotation Stable:</b><br>
                The 24-hour day remains unchanged. Clocks need no adjustment.
            `}
        </div>
    </div>

    <!-- CRATER DETAILS -->
    <div class="info-section" style="background: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #c0392b;">
            💥 Crater Formation & Structural Damage
            ${window.createInfoButton('Source', 'Collins et al. (2005) Earth Impact Effects Program; Holsapple (1993) scaling laws')}
        </h3>
        <div style="background: rgba(192,57,43,0.1); padding: 12px; border-radius: 6px; border-left: 3px solid ${disruption_color};">
            <b style="color: ${disruption_color};">${disruption_effect}:</b> ${disruption_description}<br><br>
            <b>Transient Crater Diameter:</b> ${(D_tr/1000).toFixed(2)} km<br>
            <b>Final Crater Diameter:</b> ${(D_final/1000).toFixed(2)} km<br>
            <b>Crater Depth:</b> ${(crater_depth/1000).toFixed(2)} km<br>
            <b>Crater Volume:</b> ${formatLargeNumberWords(crater_volume)} m³<br>
            <b>Excavated Mass:</b> ${formatLargeNumberWords(ejecta_mass)} kg<br>
            <b>Comparison:</b> ${(D_final/12742).toFixed(4)}% of Earth's diameter<br><br>
            ${volume_ratio > 1e-6 ? `
                <b style="color: #e74c3c;">⚠️ Geological Consequences:</b><br>
                • ${crater_depth > 35000 ? 'Mantle exposed' : 'Crust penetrated to ' + (crater_depth/1000).toFixed(1) + ' km depth'}<br>
                • Global seismic waves (magnitude ${(Math.log10(E_joules) - 4.8).toFixed(1)} earthquake)<br>
                • ${(ejecta_mass / EARTH_MASS * 100).toExponential(2)}% of Earth's mass ejected<br>
                • Crater rim height: ~${(D_final * 0.05 / 1000).toFixed(2)} km above surroundings
            ` : `
                <b>Local cratering only - planetary structure intact</b>
            `}
        </div>
    </div>

    <!-- ATMOSPHERIC EFFECTS -->
    <div class="info-section" style="background: linear-gradient(135deg, #141e30 0%, #243b55 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3498db;">
        <h3 style="margin: 0 0 10px 0; color: #3498db;">
            ☁️ Atmospheric & Climate Effects
            ${window.createInfoButton('Source', 'Toon et al. (1997) Environmental perturbations caused by impacts; Covey et al. (1994) climate models')}
        </h3>
        
        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #3498db;">🌫️ Impact Winter & Dust Loading</h4>
            <b>Ejecta Lofted:</b> ${formatLargeNumberWords(ejecta_mass)} kg<br>
            <b>Atmospheric Dust:</b> ${formatLargeNumberWords(dust_mass)} kg<br>
            <b>Optical Depth:</b> ${optical_depth.toFixed(2)} (0=transparent, 1=opaque)<br>
            <b>Sunlight Reduction:</b> ${(100 - 100 * Math.exp(-optical_depth)).toFixed(1)}%<br>
            <b>Darkness Duration:</b> ${darkness_duration.toFixed(0)} days (${(darkness_duration/365).toFixed(1)} years)<br>
            <b>Temperature Drop:</b> -${temp_drop.toFixed(1)}°C globally<br>
            <b>Cooling Duration:</b> ${cooling_duration_years.toFixed(1)} years<br><br>
            ${optical_depth > 1 ? `
                <b style="color: #e74c3c;">⚠️ Impact Winter Scenario:</b><br>
                • Photosynthesis ceases - plants die<br>
                • Food chains collapse from bottom up<br>
                • Global famine - billions of human deaths<br>
                • Freezing temperatures even at equator<br>
                • ${darkness_duration > 365 ? 'Multi-year darkness' : 'Months of darkness'}
            ` : `
                <b>Limited atmospheric disruption</b>
            `}
        </div>

        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px; margin-bottom: 10px;">
            <h4 style="margin: 0 0 8px 0; color: #e74c3c;">
                🌧️ Acid Rain & Chemical Contamination
                ${window.createInfoButton('Source', 'Pope et al. (1997) Impact winter and Cretaceous/Tertiary extinctions')}
            </h4>
            <b>Sulfur Dioxide (SO₂):</b> ${formatLargeNumberWords(SO2_mass)} kg<br>
            <b>Nitrogen Oxides (NOx):</b> ${formatLargeNumberWords(NOx_mass)} kg<br>
            <b>Acid Rain pH:</b> ${acid_rain_pH.toFixed(2)} (normal: 5.6, distilled water: 7.0)<br>
            <b>Ozone Depletion:</b> ${ozone_depletion_percent.toFixed(1)}% destroyed<br>
            <b>UV Radiation Increase:</b> ${(ozone_depletion_percent * 2).toFixed(0)}% at surface<br>
            <b>Recovery Time:</b> ${ozone_recovery_time.toFixed(0)} years<br><br>
            ${acid_rain_pH < 4 ? `
                <b style="color: #e74c3c;">⚠️ Extreme Chemical Warfare:</b><br>
                • Acid rain kills forests and crops<br>
                • Lakes and rivers acidified - aquatic die-off<br>
                • Soil fertility destroyed for decades<br>
                • UV radiation causes skin cancer, blindness<br>
                • DNA damage to all surface organisms
            ` : acid_rain_pH < 5 ? `
                <b style="color: #f39c12;">Moderate Chemical Effects:</b><br>
                • Sensitive ecosystems damaged<br>
                • Crop yields reduced by ${(100 - acid_rain_pH * 20).toFixed(0)}%
            ` : `
                <b>Minimal chemical contamination</b>
            `}
        </div>

        <div style="background: rgba(52,152,219,0.1); padding: 12px; border-radius: 6px;">
            <h4 style="margin: 0 0 8px 0; color: #e67e22;">
                🔥 Global Wildfires
                ${window.createInfoButton('Source', 'Melosh et al. (1990) Ignition of global wildfires at the K/T boundary')}
            </h4>
            <b>Thermal Radius:</b> ${(thermal_radius/1000).toFixed(0)} km<br>
            <b>Ignition Area:</b> ${formatLargeNumberWords(wildfire_area)} m² (${wildfire_percent.toFixed(3)}% of Earth)<br>
            <b>Soot Produced:</b> ${formatLargeNumberWords(soot_mass)} kg<br>
            <b>Additional Cooling:</b> ${Math.min(soot_mass / 1e12, 10).toFixed(1)}°C from soot<br><br>
            ${wildfire_percent > 1 ? `
                <b style="color: #e67e22;">⚠️ Continental-Scale Firestorm:</b><br>
                • ${(wildfire_percent * 510).toFixed(0)} million km² ignited<br>
                • Oxygen levels drop from 21% to ${(21 - wildfire_percent * 0.5).toFixed(1)}%<br>
                • CO₂ spike causes greenhouse warming after dust settles<br>
                • Stratospheric soot blocks sun for years (nuclear winter effect)
            ` : wildfire_percent > 0.01 ? `
                <b>Regional wildfires - smoke visible globally</b>
            ` : `
                <b>Localized fires only</b>
            `}
        </div>
    </div>

    <!-- MASS EXTINCTION -->
    <div class="info-section" style="background: linear-gradient(135deg, #8b0000 0%, #4a0000 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 3px solid #ff0000;">
        <h3 style="margin: 0 0 10px 0; color: #ff6b6b;">
            ☠️ Mass Extinction Risk Analysis
            ${window.createInfoButton('Source', 'Raup & Sepkoski (1982) Mass extinctions in the fossil record; Alvarez et al. (1980) K-T boundary')}
        </h3>
        <div style="background: rgba(255,0,0,0.2); padding: 15px; border-radius: 6px;">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <b style="font-size: 1.1em; color: #ff6b6b;">Extinction Severity:</b><br>
                    <span style="font-size: 1.3em; color: white;">${extinction_level}</span><br><br>
                    <b>Impact Energy:</b> ${E_megatons.toExponential(2)} MT TNT<br>
                    <b>Chicxulub Comparison:</b> ${chicxulub_ratio.toExponential(2)}× the dinosaur killer<br>
                    <b>Estimated Species Loss:</b> ${extinction_probability > 50 ? `${extinction_probability}% of all species` : `${extinction_probability}% locally`}
                </div>
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid #ff0000; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: radial-gradient(circle, #ff0000 0%, #8b0000 100%);">
                        <span style="font-size: 2.5em; font-weight: bold; color: white;">${extinction_probability}%</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em;">Extinction Risk</div>
                </div>
            </div>
            
            <b style="color: #ff6b6b;">Kill Mechanisms:</b>
            <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.7;">
                <li><b>Direct Impact:</b> Everything within ${(D_final/2000).toFixed(0)} km vaporized</li>
                <li><b>Impact Winter:</b> ${darkness_duration > 365 ? `${(darkness_duration/365).toFixed(1)} years` : `${darkness_duration.toFixed(0)} days`} of darkness → photosynthesis stops</li>
                <li><b>Starvation:</b> Food chains collapse - herbivores die in months, predators within a year</li>
                <li><b>Acid Rain:</b> pH ${acid_rain_pH.toFixed(1)} kills ${acid_rain_pH < 3 ? 'most' : 'sensitive'} plants and aquatic life</li>
                <li><b>UV Radiation:</b> ${ozone_depletion_percent.toFixed(0)}% ozone loss = lethal surface exposure</li>
                <li><b>Temperature Shock:</b> -${temp_drop.toFixed(0)}°C then +${(temp_drop * 0.5).toFixed(0)}°C rebound kills adapted species</li>
                <li><b>Wildfires:</b> ${wildfire_percent.toFixed(1)}% of surface burned</li>
            </ul>
            
            ${extinction_probability >= 75 ? `
                <div style="background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #ff0000;">
                    <b style="color: #ff0000;">⚠️ PLANETARY CATASTROPHE</b><br>
                    This impact equals or exceeds the K-Pg extinction (66 Mya) that killed the dinosaurs.<br><br>
                    <b>Expected Casualties:</b><br>
                    • Humans: ~${Math.min(extinction_probability, 99.9)}% (${(8e9 * extinction_probability / 100).toExponential(2)} people)<br>
                    • Large mammals: ${Math.min(extinction_probability + 5, 100)}%<br>
                    • Plants: ${Math.max(extinction_probability - 20, 0)}%<br>
                    • Marine life: ${Math.max(extinction_probability - 10, 0)}%<br>
                    • Insects: ${Math.max(extinction_probability - 30, 0)}%<br>
                    • Bacteria: ${Math.max(extinction_probability - 60, 5)}%<br><br>
                    <b>Recovery:</b> ${(extinction_probability / 5).toFixed(0)} million years for biodiversity restoration
                </div>
            ` : extinction_probability >= 20 ? `
                <div style="background: rgba(0,0,0,0.4); padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #f39c12;">
                    <b style="color: #f39c12;">⚠️ MASS EXTINCTION EVENT</b><br>
                    Comparable to the Permian-Triassic (252 Mya) or Late Devonian (375 Mya) extinctions.<br>
                    Human civilization likely collapses. Recovery takes millions of years.
                </div>
            ` : ''}
        </div>
    </div>

    <!-- HISTORICAL COMPARISONS -->
    <div class="info-section" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3 style="margin: 0 0 10px 0; color: #00d4ff;">
            🌍 Historical Impact Comparisons
            ${window.createInfoButton('Source', 'Earth Impact Database (2013); Grieve & Shoemaker (1994)')}
        </h3>
        <table style="width: 100%; font-size: 0.9em; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(0,212,255,0.2); border-bottom: 2px solid #00d4ff;">
                    <th style="padding: 8px; text-align: left;">Impact Event</th>
                    <th style="padding: 8px; text-align: center;">Age</th>
                    <th style="padding: 8px; text-align: center;">Energy (MT)</th>
                    <th style="padding: 8px; text-align: center;">Crater</th>
                    <th style="padding: 8px; text-align: left;">Consequences</th>
                </tr>
            </thead>
            <tbody>
                <tr style="background: rgba(108,92,231,0.3); border-bottom: 1px solid #444;">
                    <td style="padding: 8px;"><b>YOUR IMPACT</b></td>
                    <td style="padding: 8px; text-align: center;">Today</td>
                    <td style="padding: 8px; text-align: center;">${E_megatons.toExponential(2)}</td>
                    <td style="padding: 8px; text-align: center;">${(D_final/1000).toFixed(1)} km</td>
                    <td style="padding: 8px;"><b>${extinction_level}</b></td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Tunguska, Russia</td>
                    <td style="padding: 8px; text-align: center;">1908</td>
                    <td style="padding: 8px; text-align: center;">10-15</td>
                    <td style="padding: 8px; text-align: center;">0 (airburst)</td>
                    <td style="padding: 8px;">2,000 km² forest flattened, 0 deaths</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Chelyabinsk, Russia</td>
                    <td style="padding: 8px; text-align: center;">2013</td>
                    <td style="padding: 8px; text-align: center;">0.5</td>
                    <td style="padding: 8px; text-align: center;">0 (airburst)</td>
                    <td style="padding: 8px;">1,500 injured, windows shattered</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Barringer (Meteor Crater)</td>
                    <td style="padding: 8px; text-align: center;">50,000 ya</td>
                    <td style="padding: 8px; text-align: center;">10-20</td>
                    <td style="padding: 8px; text-align: center;">1.2 km</td>
                    <td style="padding: 8px;">Regional devastation, megafauna killed</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Ries Crater, Germany</td>
                    <td style="padding: 8px; text-align: center;">15 Mya</td>
                    <td style="padding: 8px; text-align: center;">~2×10⁶</td>
                    <td style="padding: 8px; text-align: center;">24 km</td>
                    <td style="padding: 8px;">European climate disrupted</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Chicxulub, Mexico</td>
                    <td style="padding: 8px; text-align: center;">66 Mya</td>
                    <td style="padding: 8px; text-align: center;">1×10⁸</td>
                    <td style="padding: 8px; text-align: center;">180 km</td>
                    <td style="padding: 8px;"><b>Killed dinosaurs - 75% species extinct</b></td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Sudbury Basin, Canada</td>
                    <td style="padding: 8px; text-align: center;">1.85 Gya</td>
                    <td style="padding: 8px; text-align: center;">~1×10⁹</td>
                    <td style="padding: 8px; text-align: center;">130 km</td>
                    <td style="padding: 8px;">Second-largest verified impact</td>
                </tr>
                <tr style="border-bottom: 1px solid #444;">
                    <td style="padding: 8px;">Vredefort, South Africa</td>
                    <td style="padding: 8px; text-align: center;">2.02 Gya</td>
                    <td style="padding: 8px; text-align: center;">~5×10⁹</td>
                    <td style="padding: 8px; text-align: center;">300 km</td>
                    <td style="padding: 8px;"><b>Largest verified impact on Earth</b></td>
                </tr>
                <tr>
                    <td style="padding: 8px;">Theia Impact (Moon-forming)</td>
                    <td style="padding: 8px; text-align: center;">4.5 Gya</td>
                    <td style="padding: 8px; text-align: center;">~1×10¹⁴</td>
                    <td style="padding: 8px; text-align: center;">N/A</td>
                    <td style="padding: 8px;">Mars-sized object, created Earth's Moon</td>
                </tr>
            </tbody>
        </table>
        <p style="margin: 10px 0 0 0; font-size: 0.85em; color: #aaa;">
            <b>Relative magnitude:</b> Your impact is <b>${chicxulub_ratio.toExponential(2)}×</b> the Chicxulub event
            ${chicxulub_ratio > 1 ? ' (more destructive than the dinosaur killer!)' : 
              chicxulub_ratio > 0.1 ? ' (comparable to the dinosaur killer)' : 
              chicxulub_ratio > 0.01 ? ' (could still cause mass extinction)' : ''}
        </p>
    </div>

    <!-- RECOVERY TIMELINE -->
    <div class="info-section" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2ecc71;">
        <h3 style="margin: 0 0 10px 0; color: white;">
            🌱 Post-Impact Recovery Timeline
            ${window.createInfoButton('Source', 'Jablonski (1995) Extinctions in the fossil record; Erwin (1998) The end and the beginning')}
        </h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em;">
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #e74c3c;">
                <b style="color: white;">Years 0-10:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ? 
                    `Impact winter active. ${temp_drop.toFixed(0)}°C cooling. Mass starvation. ${extinction_probability}% species die.` :
                  extinction_probability > 30 ?
                    `Regional devastation. Climate disrupted. Major extinctions begin.` :
                    `Local damage. Ecosystem stress. Limited global impact.`
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #e67e22;">
                <b style="color: white;">Years 10-100:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ?
                    `Dust settles. Greenhouse warming begins. Acid oceans. No megafauna survive.` :
                  extinction_probability > 30 ?
                    `Survivors adapt. Food webs rebuild slowly. Climate stabilizing.` :
                    `Rapid recovery. Ecosystems mostly restored.`
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #f39c12;">
                <b style="color: white;">Years 100-1,000:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ?
                    `Climate normalized. Surviving lineages radiate. New dominant species emerge.` :
                  extinction_probability > 30 ?
                    `Biodiversity rebounds. Ecosystems stable. Crater visible landmark.` :
                    `Full ecological recovery. Only geology remembers.`
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #f1c40f;">
                <b style="color: white;">1,000-10,000 years:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ?
                    `Evolutionary innovations. Forests regrow. New apex predators. Biodiversity 30% of pre-impact.` :
                  extinction_probability > 30 ?
                    `Near-complete recovery. Crater eroding. Human myths tell of "the great fire from sky".` :
                    `Impact crater a tourist site. Local geology altered permanently.`
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #52be80;">
                <b style="color: white;">10,000 years - 1 Mya:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ?
                    `New dominant groups established. Climate fully normalized. Biodiversity 60% restored.` :
                  extinction_probability > 30 ?
                    `Complete ecological recovery. Crater barely visible.` :
                    `Only sediment layers record the impact.`
                }
                </span>
            </div>
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; border-left: 3px solid #27ae60;">
                <b style="color: white;">1-10 Million years:</b><br>
                <span style="color: #ddd;">
                ${extinction_probability > 70 ?
                    `Biodiversity equals or exceeds pre-impact. Iridium layer marks the event in rock record.` :
                  extinction_probability > 30 ?
                    `Impact layer visible in stratigraphy. Future geologists study it.` :
                    `Geological footnote. Minor anomaly in fossil record.`
                }
                </span>
            </div>
        </div>
        ${extinction_probability > 50 ? `
            <div style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.4); border-radius: 6px; border-left: 3px solid #27ae60;">
                <b style="color: #2ecc71;">🔬 Recovery Science:</b><br>
                <span style="color: #ddd; font-size: 0.9em;">
                After the K-Pg extinction, mammals evolved from small shrews to elephants and whales in just 10 million years.
                Empty niches drive rapid evolution. Small, adaptable species inherit the Earth. The "disaster taxa" 
                (ferns, fungi, algae) dominate initially, then complex ecosystems rebuild from the bottom up.
                </span>
            </div>
        ` : ''}
    </div>

    <!-- SCIENTIFIC REFERENCES -->
    <div class="info-section" style="background: #16213e; padding: 15px; border-radius: 8px; border: 2px solid #6c5ce7;">
        <h3 style="margin: 0 0 10px 0; color: #6c5ce7;">📚 Scientific Sources & Methodology</h3>
        <div style="color: #aaa; font-size: 0.85em; line-height: 1.8;">
            <b style="color: #00d4ff;">Key References:</b>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li><b>Crater Scaling:</b> Holsapple, K.A. (1993) "The scaling of impact processes in planetary sciences" <i>Annual Review Earth Planet. Sci.</i> 21:333-373</li>
                <li><b>Impact Effects:</b> Collins, G.S., Melosh, H.J., Marcus, R.A. (2005) "Earth Impact Effects Program" <i>Meteoritics & Planetary Science</i> 40:817-840</li>
                <li><b>Climate Effects:</b> Toon, O.B., et al. (1997) "Environmental perturbations caused by the impacts of asteroids and comets" <i>Reviews of Geophysics</i> 35:41-78</li>
                <li><b>Impact Winter:</b> Covey, C., et al. (1994) "Global climatic effects of atmospheric dust from an asteroid or comet impact" <i>Global and Planetary Change</i> 9:263-273</li>
                <li><b>Wildfires:</b> Melosh, H.J., et al. (1990) "Ignition of global wildfires at the Cretaceous/Tertiary boundary" <i>Nature</i> 343:251-254</li>
                <li><b>Mass Extinction:</b> Alvarez, L.W., et al. (1980) "Extraterrestrial cause for the Cretaceous-Tertiary extinction" <i>Science</i> 208:1095-1108</li>
                <li><b>Chicxulub Impact:</b> Schulte, P., et al. (2010) "The Chicxulub asteroid impact and mass extinction at the K-Pg boundary" <i>Science</i> 327:1214-1218</li>
                <li><b>Orbital Mechanics:</b> Korycansky, D.G., Laughlin, G., Adams, F.C. (2001) "Astronomical engineering: a strategy for modifying planetary orbits" <i>Astrophysics & Space Science</i> 275:349-366</li>
            </ul>
            <br>
            <b style="color: #00d4ff;">Calculation Methods:</b>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li><b>Energy:</b> E = ½mv² (classical kinetic energy)</li>
                <li><b>Crater diameter:</b> Holsapple π-scaling with gravity regime</li>
                <li><b>Optical depth:</b> τ = κ × Σ (extinction coefficient × column density)</li>
                <li><b>Temperature drop:</b> ΔT ∝ τ with saturation at 25°C</li>
                <li><b>Momentum transfer:</b> Δv = (m_impact × v) / M_Earth</li>
                <li><b>Angular momentum:</b> L = m × v × r (perpendicular impact assumption)</li>
            </ul>
            <br>
            <b style="color: #00d4ff;">Assumptions & Uncertainties:</b>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>Target rock density: 2,500 kg/m³ (continental crust average)</li>
                <li>Vertical impact angle: ${angle}° from horizontal</li>
                <li>Maximum angular momentum transfer assumed (perpendicular equatorial impact)</li>
                <li>Dust particle size: 1 μm (optimal for light scattering)</li>
                <li>No account for specific target geology (sediment vs. basement rock)</li>
                <li>Climate models simplified - actual effects depend on impact location, season, ocean vs. land</li>
                <li>Extinction probability based on fossil record correlation, not mechanistic modeling</li>
            </ul>
            <br>
            <p style="margin: 0; padding: 10px; background: rgba(108,92,231,0.2); border-radius: 5px; border-left: 3px solid #6c5ce7;">
                <b style="color: #6c5ce7;">⚠️ Scientific Note:</b> These calculations use peer-reviewed empirical scaling laws 
                calibrated to nuclear weapons tests, laboratory impact experiments, and the geological/fossil record of 
                real impact events. The Chicxulub impact (66 Mya) provides the best calibration for global effects. 
                Uncertainties increase for impacts larger than Chicxulub as we enter regimes with no modern analogs.
            </p>
        </div>
    </div>
    `;
}
async function initGlobalEffectsCharts() {
    if (!asteroidData) return;
    
    // Constants
    const EARTH_MASS = 5.972e24;
    const EARTH_ORBITAL_VELOCITY = 29780;
    const EARTH_ANGULAR_MOMENTUM = 5.86e33;
    const EARTH_RADIUS = 6371000;
    const EARTH_VOLUME = (4/3) * Math.PI * Math.pow(EARTH_RADIUS, 3);
    
    // Calculations
    const r_m = asteroidData.radius;
    const rho = asteroidData.density;
    const v = asteroidData.velocity * 1000;
    const m = (4/3) * Math.PI * Math.pow(r_m, 3) * rho;
    const E_joules = 0.5 * m * v * v;
    const E_megatons = E_joules / 4.184e15;
    
    const impactor_momentum = m * v;
    const earth_momentum = EARTH_MASS * EARTH_ORBITAL_VELOCITY;
    const momentum_ratio = impactor_momentum / earth_momentum;
    
    const impact_angular_momentum = m * v * EARTH_RADIUS;
    const angular_momentum_ratio = impact_angular_momentum / EARTH_ANGULAR_MOMENTUM;
    
    const transient_crater_diameter = 1.161 * Math.pow(r_m, 0.78) * Math.pow(v/1000, 0.44) * Math.pow(rho/2700, 0.36) * Math.pow(2.7, -0.22);
    const transient_crater_depth = transient_crater_diameter / 3;
    const transient_crater_volume = (1/3) * Math.PI * Math.pow(transient_crater_diameter * 1000 / 2, 2) * transient_crater_depth * 1000;
    const volume_ratio = transient_crater_volume / EARTH_VOLUME;
    
    // Chart 1: Global Ratios Comparison
    new Chart(document.getElementById('globalRatiosChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Orbital\nMomentum', 'Rotational\nAngular Momentum', 'Planetary\nVolume'],
            datasets: [{
                label: 'Impact/Earth Ratio',
                data: [momentum_ratio, angular_momentum_ratio, volume_ratio],
                backgroundColor: ['#6c5ce7', '#e67e22', '#c0392b'],
                borderColor: '#00d4ff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Impact vs Earth: Fundamental Property Ratios',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'logarithmic',
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Ratio (log scale)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 2: Atmospheric Effects Timeline
    const ejecta_mass = Math.pow(E_megatons, 0.6) * 1e12;
    const dust_mass = ejecta_mass * 0.1;
    const atmospheric_optical_depth = Math.min((dust_mass / 5e15), 100);
    const darkness_duration_days = atmospheric_optical_depth * 30;
    const immediate_cooling = Math.min(atmospheric_optical_depth * 0.5, 50);
    
    const timeLabels = ['Day 1', 'Week 1', 'Month 1', '6 Months', '1 Year', '5 Years', '10 Years'];
    const tempData = [
        -immediate_cooling,
        -immediate_cooling * 0.95,
        -immediate_cooling * 0.85,
        -immediate_cooling * 0.6,
        -immediate_cooling * 0.4,
        -immediate_cooling * 0.1,
        immediate_cooling * 0.05 // Greenhouse warming begins
    ];
    const lightData = [
        Math.max(100 - atmospheric_optical_depth * 90, 1),
        Math.max(100 - atmospheric_optical_depth * 85, 5),
        Math.max(100 - atmospheric_optical_depth * 70, 15),
        Math.max(100 - atmospheric_optical_depth * 40, 40),
        Math.max(100 - atmospheric_optical_depth * 20, 60),
        90,
        95
    ];
    
    new Chart(document.getElementById('atmosphericEffectsChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: timeLabels,
            datasets: [
                {
                    label: 'Temperature Change (°C)',
                    data: tempData,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231,76,60,0.2)',
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Sunlight (% of normal)',
                    data: lightData,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243,156,18,0.2)',
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Atmospheric Conditions Over Time',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: '#e74c3c' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Temperature Change (°C)',
                        color: '#e74c3c'
                    }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#f39c12' },
                    grid: { display: false },
                    title: {
                        display: true,
                        text: 'Sunlight (%)',
                        color: '#f39c12'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' }
                }
            }
        }
    });
    
    // Chart 3: Extinction Timeline
    let extinction_probability;
    if (E_megatons < 100) extinction_probability = 0;
    else if (E_megatons < 1000) extinction_probability = 10;
    else if (E_megatons < 10000) extinction_probability = 30;
    else if (E_megatons < 100000) extinction_probability = 60;
    else extinction_probability = 95;
    
    const extinctionData = {
        labels: ['Hours', 'Days', 'Weeks', 'Months', 'Years', 'Decades', 'Centuries'],
        datasets: [{
            label: 'Species Extinction (%)',
            data: [
                extinction_probability * 0.1,
                extinction_probability * 0.3,
                extinction_probability * 0.5,
                extinction_probability * 0.7,
                extinction_probability * 0.85,
                extinction_probability * 0.95,
                extinction_probability
            ],
            borderColor: '#c0392b',
            backgroundColor: 'rgba(192,57,43,0.3)',
            fill: true,
            tension: 0.4,
            borderWidth: 3
        }]
    };
    
    new Chart(document.getElementById('extinctionTimelineChart').getContext('2d'), {
        type: 'line',
        data: extinctionData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: 'white' }
                },
                title: {
                    display: true,
                    text: 'Cumulative Species Extinction Over Time',
                    color: 'white',
                    font: { size: 14 }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { 
                        color: 'white',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Species Lost (%)',
                        color: 'white'
                    }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: '#333' },
                    title: {
                        display: true,
                        text: 'Time After Impact',
                        color: 'white'
                    }
                }
            }
        }
    });
}




</script>

</body>
</html>